{"pageProps":{"member":{"id":"hiroki-hasegawa","name":"Hiroki Hasegawa","role":"SRE","bio":"Let me know your favorite technology!","avatarSrc":"/avatars/hirokihasegawa.png","sources":["https://hiroki-hasegawa.hatenablog.jp/feed"],"includeUrlRegex":"","twitterUsername":"Hiroki__IT","githubUsername":"hiroki-it","websiteUrl":"https://hiroki-it.github.io/tech-notebook-mkdocs/"},"postItems":[{"title":"Istioâ›µï¸ã«ã‚ˆã‚‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿","contentSnippet":"ç›®æ¬¡01. ã¯ã˜ã‚ã«02. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥03. admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã«ã¤ã„ã¦04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿05. ãŠã‚ã‚Šã«01. ã¯ã˜ã‚ã«ã©ãƒ¼ã‚‚ã€‚æ­£æœˆã§æ¿€å¤ªã‚Šã—ã¾ã—ãŸãŒã€ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ğŸ™‹ğŸ»â€â™‚ï¸ä»Šå›ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹Istioâ›µï¸ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚å‰å›ã®è¨˜äº‹ã«å¼•ãç¶šãIstioã§ã™ã€‚hiroki-hasegawa.hatenablog.jpåŸ·ç­†æ™‚ç‚¹ï¼ˆ2023/01/14ï¼‰ã§ã¯ã€IstioãŒå®Ÿè£…ã™ã‚‹ã‚µãƒ¼ãƒ“ãƒ¡ãƒƒã‚·ãƒ¥ã«ã¯ã€ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã€ã¨ã€ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ¡ãƒƒã‚·ãƒ¥ã€ãŒã‚ã‚Šã¾ã™ã€‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿ã®è»¸ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹istio-proxyã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚Istioã¯ã€Kubernetesã®Podã®ä½œæˆæ™‚ã«ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’Podå†…ã«è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ³¨å…¥ï¼‰ã—ã¾ã™æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ğŸ˜—ï¼ˆæ²¼ã®ã¾ã‚ã‚Šã«é¤Œã‚’ã¾ãï¼‰02. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãªãœã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ãªã®ã‹ãã‚‚ãã‚‚ã€ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ã«ãªã£ãŸã®ã§ã—ã‚‡ã†ã‹ã€‚ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã¯ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›ºæœ‰ã®ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œï¼ˆä¾‹ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®å¿…è¦æ€§ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®æš—å·åŒ–ã€ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼åé›†ã€ãªã©ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒå„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å†…ã«ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã«é–¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚Œã°ã€ã“ã‚Œã‚‰ã®å•é¡Œã®è§£æ±ºã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã‚¢ãƒ—ãƒªé ˜åŸŸã®å•é¡Œã«è²¬å‹™ã‚’æŒã¡ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§è§£æ±ºã™ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒã€äº’ã„ã«åŠ¹ç‡çš„ã«é–‹ç™ºã§ãã¾ã™ã€‚ãã“ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦åˆ‡ã‚Šåˆ†ã‘ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è²¬å‹™ã‚’åˆ†é›¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«æä¾›ã§ãã‚‹ãŸã‚ã€å˜ç´”æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ã“ã†ã„ã£ãŸæµã‚Œã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãŒç™»å ´ã—ã¾ã—ãŸã€‚â„¹ï¸ å‚è€ƒï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã€IstioãŒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶å¾¡ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€å¯è¦³æ¸¬æ€§ã«æ¬ ã‹ã›ãªã„ç†ç”±ï¼šCloud Nativeãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆï¼ˆ9ï¼‰ - ï¼ ITWhat is Service Mesh and Why is it Necessary?ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ï¼ˆã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ï¼‰ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠï¼ˆistio-proxyã‚³ãƒ³ãƒ†ãƒŠï¼‰ãŒç¨¼åƒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä¸­å¤®é›†æ¨©çš„ã«ç®¡ç†ã™ã‚‹Istiodï¼ˆdiscoveryã‚³ãƒ³ãƒ†ãƒŠï¼‰ãŒç¨¼åƒã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‹ã‚‰ãªã‚Šã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šIstio / Architecture03. admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã«ã¤ã„ã¦admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã¯Istioã®Podå†…ã¸ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å‰æçŸ¥è­˜ã¨ã—ã¦ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã—ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ ã¾ã§é£›ã°ã—ã¦ãã ã•ã„ã€‚kube-apiserverã§ã¯ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã—ã¦æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã¨validating-admissionã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã§ãã€admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆkubectlã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€Kubernetesãƒªã‚½ãƒ¼ã‚¹ï¼‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä¾‹ï¼šKubernetesãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ä½œæˆ/æ›´æ–°/å‰Šé™¤ã€kube-apiserverã‹ã‚‰ã®ãƒ—ãƒ­ã‚­ã‚·ã¸ã®è»¢é€ï¼‰æ™‚ã«ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã‚‹å‡¦ç†ï¼ˆä¾‹ï¼šã‚¢ãƒ‰ã‚ªãƒ³ãƒ“ãƒ«ãƒˆã‚¤ãƒ³å‡¦ç†ã€ç‹¬è‡ªå‡¦ç†ï¼‰ã‚’ç™ºç«ã•ã›ã‚‰ã‚Œã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šAdmission Controllers Reference | KubernetesKubernetes Best Practices: Blueprints for Building Successful Applications on Kubernetes: Burns, Brendan, Villalba, Eddie, Strebel, Dave, Evenson, Lachlan: 9781492056478: Amazon.com: Booksadmissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¯ã€ãŸãã•ã‚“ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚IstioãŒPodå†…ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹æ™‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¢ãƒ‰ã‚ªãƒ³ã¯ã€ã€MutatingAdmissionWebhookã€ã§ã™ã€‚CertificateApprovalCertificateSigningCertificateSubjectRestrictionDefaultIngressClassDefaultStorageClassDefaultTolerationSecondsLimitRangerMutatingAdmissionWebhook ğŸ‘ˆ ã“ã‚Œï¼NamespaceLifecyclePersistentVolumeClaimResizePodSecurityPriorityResourceQuotaRuntimeClassServiceAccountStorageObjectInUseProtectionTaintNodesByConditionValidatingAdmissionWebhookâ„¹ï¸ å‚è€ƒï¼šAdmission Controllers Reference | KubernetesMutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã¯MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—æ™‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†ã‚’ãƒ•ãƒƒã‚¯ã§ãã¾ã™ã€‚ãƒ•ãƒƒã‚¯ã™ã‚‹å…·ä½“çš„ãªå‡¦ç†ã¨ã—ã¦ã€webhookã‚µãƒ¼ãƒãƒ¼ã«AdmissionRequestãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å‹•çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚MutatingWebhookConfigurationã§ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚MutatingWebhookConfigurationã®å…·ä½“çš„ãªå®Ÿè£…ã«ã¤ã„ã¦ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šDiving into Kubernetes MutatingAdmissionWebhook | by Morven Cao | IBM Cloud | Mediumhttps://gashirar.hatenablog.com/entry/2020/10/31/141357/Admission Webhookã‚’ä½œã£ã¦éŠã‚“ã§ã€ãã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã‚ˆã†ï¼ˆèª¬æ˜ç·¨ï¼‰AdmissionReviewã€AdmissionRequestã€AdmissionResponseâ–¼ AdmissionReviewAdmissionReviewã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã‚ã‚Šã€kube-apiserverã¨webhookã‚µãƒ¼ãƒãƒ¼ã®é–“ã§AdmissionRequestã¨AdmissionResponseã‚’é‹ã³ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {},  # AdmissionResponse  \"response\": {}  }â„¹ï¸ å‚è€ƒï¼šv1 package - k8s.io/api/admission/v1 - Go Packagesâ–¼ AdmissionRequestAdmissionRequestã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚kube-apiserverãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ä¿¡ã—ãŸæ“ä½œå†…å®¹ãŒæŒã¤ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ä¾‹ã§æŒ™ã’ãŸAdmissionRequestã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒDeploymentã‚’CREATEæ“ä½œã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {    ...    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"resource\": {      \"group\": \"apps\",      \"version\": \"v1\",      \"resource\": \"deployments\"    },    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"operation\": \"CREATE\",    ...  }}â„¹ï¸ å‚è€ƒï¼šDynamic Admission Control | Kubernetesâ–¼ AdmissionResponseä¸€æ–¹ã§AdmissionResponseã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚AdmissionResponseã«å¿œã˜ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå¤‰æ›´å‡¦ç†ã‚’patchã‚­ãƒ¼ã®å€¤ã«æŒã¡ã€ã“ã‚Œã¯base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionResponse  \"response\": {    \"uid\": \"<value from request.uid>\",    # å®›å…ˆã®webhookã‚µãƒ¼ãƒãƒ¼ãŒå—ä¿¡ã—ãŸã‹å¦ã‹ã‚’è¡¨ã™ã€‚    \"allowed\": true,    # Pathã«ã‚ˆã‚‹Patchå‡¦ç†ã‚’è¡Œã†ã€‚    \"patchType\": \"JSONPatch\",    # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚    \"patch\": \"W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0=\"  }}ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å€¤ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªpatchå‡¦ç†ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«å¯¾ã™ã‚‹æ“ä½œï¼ˆopï¼‰ã€ã‚­ãƒ¼ï¼ˆpathï¼‰ã€å€¤ï¼ˆvalueï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚ä¾‹ã«æŒ™ã’ãŸpatchã‚­ãƒ¼ã§ã¯ã€ã‚­ãƒ¼ï¼ˆspec.replicasï¼‰ã¨å€¤ï¼ˆ3ï¼‰ã®è¿½åŠ å‡¦ç†ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã«åŠ ãˆã•ã›ã‚‹ã‚ˆã†ã«ã€kube-apiserverã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚# patchã‚­ãƒ¼ã‚’base64æ–¹å¼ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå ´åˆ[  {    \"op\": \"add\",    \"path\": \"/spec/replicas\",    \"value\": 3  }]â„¹ï¸ å‚è€ƒï¼šDynamic Admission Control | Kubernetes04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼å‰æçŸ¥è­˜ã‚’è¸ã¾ãˆãŸä¸Šã§ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒã©ã®ã‚ˆã†ã«Podã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚æœ€åˆã«ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚ç”»åƒã®æ–‡å­—ãŒå°ã•ããªã£ã¦ã—ã¾ã£ãŸãŸã‚ã€æ‹¡å¤§ã—ã¦ã„ãŸã ã‘ã‚‹ã¨ğŸ™‡ğŸ»â€â™‚ï¸â„¹ï¸ å‚è€ƒï¼šAmazon.co.jp: Istio in Action (English Edition) é›»å­æ›¸ç±: Posta, Christian E., Maloku, Rinor: æ´‹æ›¸ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼‘ï¼‰Podã®ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ãšã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒkube-apiserverã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã“ã‚ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆDeploymentã€DaemonSetã€StatefulSetã€ã‚’å«ã‚€ï¼‰ã¯ã€Podã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ã¾ã™ã€‚ã“ã®æ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã¨ã—ã¾ã™ã€‚# Podã‚’ä½œæˆã™ã‚‹ã€‚$ kubectl apply -f foo-pod.yaml# foo-pod.yamlãƒ•ã‚¡ã‚¤ãƒ«apiVersion: v1kind: Podmetadata:  name: foo-pod  namespace: foo-namespacespec:  containers:    - name: foo      image: foo:1.0.0      ports:        - containerPort: 80kube-apiserver â¡ï¸ Serviceã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¡ï¸ Serviceã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼’ï¼‰èªè¨¼èªå¯å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™ã€‚ï¼ˆï¼“ï¼‰ã‚¢ãƒ‰ã‚ªãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚å‰æçŸ¥è­˜ã®éƒ¨åˆ†ã§å…·ä½“çš„ãªå®Ÿè£…ã‚’çœç•¥ã—ã¾ã—ãŸãŒã€Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.14.3æ™‚ç‚¹ã§ã€MutatingWebhookConfigurationã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-sidecar-injector-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·> -o yamlapiVersion: admissionregistration.k8s.io/v1beta1kind: MutatingWebhookConfigurationmetadata:  name: istio-sidecar-injector-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>  labels:    app: sidecar-injectorwebhooks:  - name: rev.namespace.sidecar-injector.istio.io    # MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã®ç™ºç«æ¡ä»¶ã‚’ç™»éŒ²ã™ã‚‹ã€‚    rules:      - apiGroups: [\"\"]        apiVersions: [\"v1\"]        operations: [\"CREATE\"]        resources: [\"pods\"]        scope: \"*\"    # Webhookã®å‰æ®µã«ã‚ã‚‹Serviceã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã€‚    clientConfig:      service:        name: istiod-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>        namespace: istio-system        path: \"/inject\" # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ        port: 443      caBundle: Ci0tLS0tQk ...    # ç‰¹å®šã®Namespaceã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚    namespaceSelector:      matchExpressions:        - key: istio.io/rev          operator: DoesNotExist        - key: istio-injection          operator: DoesNotExist    # ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚    objectSelector:      matchExpressions:        - key: sidecar.istio.io/inject          operator: NotIn          values:            - \"false\"        - key: istio.io/rev          operator: In          values:            - <ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>    ...MutatingWebhookConfigurationã«ã¯ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’å®šç¾©ã—ã¾ã™ã€‚MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã«é–¢ã—ã¦ã€ä¾‹ãˆã°Istioã§ã¯ã€metadata.labelsã‚­ãƒ¼ã«å¿œã˜ã¦ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã€ã“ã‚Œã‚’MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã«é–¢ã—ã¦ã€Istioã§ã¯webhookã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«Serviceã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒç™ºç«ã—ãŸå ´åˆã€Serviceã®/inject:443ã«HTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ä¸€æ–¹ã§ç™ºç«ã—ãªã‹ã£ãŸå ´åˆã«ã¯ã€ä»¥é™ã®AdmissionReviewã®å‡¦ç†ã«ã¯é€²ã¿ã¾ã›ã‚“ã€‚ï¼ˆï¼”ï¼‰AdmissionRequestã«å€¤ã‚’è©°ã‚ã‚‹kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ï¼ˆPodã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionRequestã«è©°ã‚ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {    ...    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"resource\": {      \"group\": \"core\",      \"version\": \"v1\",      \"resource\": \"pods\"    },    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"operation\": \"CREATE\",    ...  }}ï¼ˆï¼•ï¼‰AdmissionReviewã‚’é€ä¿¡kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€Serviceã®/inject:443ã«AdmissionReviewæ§‹é€ ä½“ã‚’é€ä¿¡ã—ã¾ã™ã€‚Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼–ï¼‰15017ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°Serviceã¯ã€/inject:443ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã®15017ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.14.3æ™‚ç‚¹ã§ã€Serviceã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚$ kubectl get svc istiod-service -n istio-system -o yamlapiVersion: v1kind: Servicemetadata:  namespace: istio-system  name: istiod-<ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>  labels:    app: istiodspec:  type: ClusterIP  selector:    app: istiod    istio.io/rev: <ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·>  ports:    - name: grpc-xds      port: 15010      protocol: TCP      targetPort: 15010    - name: https-dns      port: 15012      protocol: TCP      targetPort: 15012    # webhookã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚    - name: https-webhook      port: 443      protocol: TCP      targetPort: 15017    - name: http-monitoring      port: 15014      protocol: TCP      targetPort: 15014Istioã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã§webhookã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã—ã€15017ç•ªãƒãƒ¼ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¾ã™ã€‚ã“ã“ã§ã€discoveryã‚³ãƒ³ãƒ†ãƒŠãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€15017ç•ªãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚$ kubectl exec foo-istiod -n istio-system -- netstat -tulpnActive Internet connections (only servers)Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    tcp        0      0 127.0.0.1:9876          0.0.0.0:*               LISTEN      1/pilot-discovery   tcp6       0      0 :::15017                :::*                    LISTEN      1/pilot-discovery   tcp6       0      0 :::8080                 :::*                    LISTEN      1/pilot-discovery   tcp6       0      0 :::15010                :::*                    LISTEN      1/pilot-discovery   tcp6       0      0 :::15012                :::*                    LISTEN      1/pilot-discovery   tcp6       0      0 :::15014                :::*                    LISTEN      1/pilot-discovery â„¹ï¸ å‚è€ƒï¼šistio/webhook.go at 1.14.3 Â· istio/istio Â· GitHubIstio / Application Requirementskube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼—ï¼‰patchå‡¦ç†ã‚’å®šç¾©ä»•çµ„ã¿ã®ä¸­ã§ã‚‚ã€ã“ã“ã¯é‡è¦ãªéƒ¨åˆ†ã§ã™ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã®patchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®spec.containers[1]ãƒ‘ã‚¹ã«istio-proxyã‚­ãƒ¼ã‚’è¿½åŠ ã•ã›ã‚‹ã‚ˆã†ãªpatchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã®å®šç¾©ã«ã‚ˆã£ã¦ã€çµæœçš„ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒèµ·ã“ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚[  ...  {    \"op\": \"add\",    # spec.initContainers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚    \"path\": \"/spec/initContainers/1\",    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚    \"value\": {        \"name\": \"istio-init\",        \"resources\": {           ...                    }    }  },  {    \"op\": \"add\",    # spec.containers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚    \"path\": \"/spec/containers/1\",    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚    \"value\": {        \"name\": \"istio-proxy\",        \"resources\": {           ...                    }    }  }    ...    ]â„¹ï¸ å‚è€ƒï¼šistio/webhook.go at a19b2ac8af3ad937640f6e29eed74472034de2f5 Â· istio/istio Â· GitHubistio/webhook_test.go at 1.14.3 Â· istio/istio Â· GitHubæœ¬é¡Œã¨è©±ãŒé€¸ã‚Œã‚‹ãŸã‚ä»Šå›ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€ä¸Šè¨˜ã®pathcå‡¦ç†ã§ã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€initã‚³ãƒ³ãƒ†ãƒŠã®istio-initã‚³ãƒ³ãƒ†ãƒŠã‚‚ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®istio-initã‚³ãƒ³ãƒ†ãƒŠã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¤Podã§ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰/ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®çµŒè·¯ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã€Podå†…ã«iptablesã®ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šIstio Sidecar's interception mechanism for traffic - SoByteï¼ˆï¼˜ï¼‰AdmissionResponseã«å€¤ã‚’è©°ã‚ã‚‹discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionResponseã«è©°ã‚ã¾ã™ã€‚patchã‚­ãƒ¼ã®å€¤ã«ã€å…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionResponse  \"response\": {    \"uid\": \"*****\",    \"allowed\": true,    \"patchType\": \"JSONPatch\",    # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚    \"patch\": \"<å…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—>\"  }}â„¹ï¸ å‚è€ƒï¼šistio/webhook.go at 1.14.3 Â· istio/istio Â· GitHubï¼ˆï¼™ï¼‰AdmissionReviewã‚’è¿”ä¿¡discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦kube-apiserverã«è¿”ä¿¡ã—ã¾ã™ã€‚kube-apiserver â¡ï¸ etcdã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¡ï¸ etcdã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼‘ï¼ï¼‰patchå‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’å—ä¿¡ã—ã€AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReviewæ§‹é€ ä½“ã‹ã‚‰å–ã‚Šå‡ºã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¨istio-initã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®è©²å½“ç®‡æ‰€ã«ã‚­ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚apiVersion: v1kind: Podmetadata:  name: foo-pod  namespace: foo-namespacespec:  containers:    - name: foo      image: foo:1.0.0      ports:        - containerPort: 80    # kube-apiserverãŒè¿½åŠ     - name: istio-proxy      ...  # kube-apiserverãŒè¿½åŠ   initContainers:    - name: istio-init    ...ï¼ˆï¼‘ï¼‘ï¼‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–kube-apiserverã¯ã€etcdã«Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚ï¼ˆï¼‘ï¼’ï¼‰ã‚³ãƒ¼ãƒ«å®Œäº†ã‚’è¿”ä¿¡kube-apiserverã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã™ã€‚$ kubectl apply -f foo-pod.yamlpod \"foo-pod\" created # <--- kube-apiserverã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ä»¥é™ã®ä»•çµ„ã¿kube-apiserverã¯ã€ä»–ã®Nodeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆkube-controlleretcdã€kube-schedulerã€kubeletã€ãªã©ï¼‰ã¨é€šä¿¡ã—ã€Podã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¨istio-initã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚çµæœã¨ã—ã¦ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚æœ¬é¡Œã¨è©±ãŒé€¸ã‚Œã‚‹ãŸã‚ä»Šå›ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€kube-apiserverã¨ä»–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€šä¿¡ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æ–¹ã®è¨˜äº‹ã¨å›³ãŒéå¸¸ã«å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ğŸ™‡ğŸ»â€â™‚ï¸â„¹ï¸ å‚è€ƒï¼šKubernetes Master Components: Etcd, API Server, Controller Manager, and Scheduler | by Jorge Acetozi | jorgeacetozi | Medium05. ãŠã‚ã‚Šã«ä»Šå›ã€Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚æœ€å¾Œã¾ã§ãŠä»˜ãåˆã„ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¡ãªã¿ã«ã€ä»Šå›ç™»å ´ã—ãŸMutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«é–¢ã—ã¦ã€ç§ã®é–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯Istioä»¥å¤–ï¼ˆä¾‹ï¼šCertManagerã€Prometheusã€eks-vpc-cniã‚¢ãƒ‰ã‚ªãƒ³ã€ãªã©ï¼‰ã§ã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã©ã®ã‚ˆã†ã«ä½¿ã£ã¦ã„ã‚‹ã®ã‹ã‚’ä¸€åº¦çŸ¥ã‚Œã°ã€çŸ¥è­˜ã®æ±ç”¨æ€§ãŒé«˜ã„ã¨è€ƒãˆã¦ã„ã¾ã™âœŒğŸ»ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯Istioã§ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã§ã‚ã‚Šã€ã‚‚ã—æœªä½“é¨“ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã‚Œã°ã€ãŠæ‰‹å…ƒã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ãŸã ãã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ğŸ‘","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2023/01/14/223815","isoDate":"2023-01-14T13:38:15.000Z","dateMiliSeconds":1673703495000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"},{"title":"Istioâ›µï¸ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ’ã‚™ã‚¹ãƒ†ã‚™ã‚£ã‚¹ã‚«ãƒã‚™ãƒªãƒ¼ã®ä»•çµ„ã¿","contentSnippet":"ç›®æ¬¡01. ã¯ã˜ã‚ã«02. ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«ã¤ã„ã¦03. Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼04. istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã®ä»•çµ„ã¿05. ãŠã‚ã‚Šã«è¬è¾01. ã¯ã˜ã‚ã«3-shake Advent Calender 2022 æœ€çµ‚æ—¥ã®è¨˜äº‹ã§ã™ğŸ…ğŸ„ç§ã¯æ™®æ®µã¯ ä¿ºã®æŠ€è¡“ãƒãƒ¼ãƒˆ ã«çŸ¥è¦‹ã‚’è¨˜éŒ²ã—ã¦ãŠã‚Šã€ã¯ã¦ãªãƒ–ãƒ­ã‚°ã¯ãƒ‡ãƒ“ãƒ¥ãƒ¼æˆ¦ã¨ãªã‚Šã¾ã™ã€‚ã•ã¦ä»Šå›ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹Istioâ›µï¸ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«é–¢ã™ã‚‹è¨˜äº‹ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚Istioã®æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã€ã®ä»•çµ„ã¿ã‚’ã€Envoyã‚’äº¤ãˆãªãŒã‚‰ã€ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã‚ˆã†ã¨æ€ã„ã¾ã™ï¼ˆæ²¼ã®ã¾ã‚ã‚Šã«é¤Œã‚’ã¾ãï¼‰ã€‚ãªãŠä»Šå›ã®è¨˜äº‹ã§ã¯ã€å…ˆæ—¥ã® 3-shake SRE Tech Talk ã§ç™ºè¡¨ã—ãŸå†…å®¹ã«åŠ ãˆã¦ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã®ä½™ç™½ã¨ç™ºè¡¨æ™‚é–“ã®åˆ¶ç´„ã§è¨˜è¼‰ã§ããªã‹ã£ãŸã“ã¨ã‚‚è¨˜è¼‰ã—ã¾ã—ãŸğŸ˜—â„¹ï¸ å‚è€ƒï¼šIstioâ›µï¸ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ’ã‚™ã‚¹ãƒ†ã‚™ã‚£ã‚¹ã‚«ãƒã‚™ãƒªãƒ¼ã®ä»•çµ„ã¿ - Speaker Deck02. ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«ã¤ã„ã¦ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¨ã¯ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å ´é¢ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¨ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆæƒ…å ±ï¼ˆä¾‹ï¼šIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€å®Œå…¨ä¿®é£¾ãƒ‰ãƒ¡ã‚¤ãƒ³åã€ãªã©ï¼‰ã‚’æ¤œå‡ºã—ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¶™ç¶šçš„ã«é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ã®ã“ã¨ã§ã™ã€‚ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ãŒå¿…è¦ãªã®ã‹ãã‚‚ãã‚‚ã€ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ãŒå¿…è¦ãªã®ã§ã—ã‚‡ã†ã‹ã€‚ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ï¼ˆå®šã‚ã‚‰ã‚ŒãŸæ¡ä»¶ä¸‹ã§å®šã‚ã‚‰ã‚ŒãŸæœŸé–“ã«ã‚ãŸã‚Šã€éšœå®³ã‚’ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ãªãå®Ÿè¡Œã™ã‚‹ç¨‹åº¦ï¼‰ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã«ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ã“ã®æ™‚ã€è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå¢—åŠ ã™ã‚‹ãŸã³ã«ã€å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯æ–°ã—ã„å®›å…ˆæƒ…å ±ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã¾ãŸã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒä½œã‚Šç›´ã•ã‚ŒãŸå ´åˆã«ã‚‚ã€å®›å…ˆæƒ…å ±ã¯æ›´æ–°ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã€ãŸã¨ãˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®›å…ˆæƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã—ã¦ã‚‚ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ãªã„ä»•çµ„ã¿ãŒå¿…è¦ã§ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®è¦ç´ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿ã¯ã€æ¬¡ã®è¦ç´ ã‹ã‚‰ãªã‚Šã¾ã™ã€‚åå‰è§£æ±ºã«é–¢ã—ã¦ã¯ã€DNSãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ï¼ˆä¾‹ï¼šCoreDNS + Service + kube-proxyã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ï¼‰ã§å¿…è¦ã¨ãªã‚Šã€Istioã§ã¯ä½¿ã„ã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€æœ¬è¨˜äº‹ã§ã¯è¨€åŠã—ãªã„ã“ã¨ã¨ã—ã¾ã™ğŸ™‡ğŸ»â€â™‚ï¸ è¦ç´             è²¬å‹™                                          é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹  ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚                                 å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã™ã‚‹ã€‚                                 ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒª       å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆæƒ…å ±ã‚’ä¿ç®¡ã™ã‚‹ã€‚                 ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼        å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹ã€‚              åå‰è§£æ±º        å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ã«ã€åå‰è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿ã«ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¯ã€ã“ã®ã†ã¡ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã€å•ã„åˆã‚ã›ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã®è²¬å‹™ãŒåˆ‡ã‚Šé›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å•ã„åˆã‚ã›ã€ã¾ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã„ã¾ã™ã€‚ï¼ˆä¾‹ï¼‰Istioã€Linkerdã€ãªã©â„¹ï¸ å‚è€ƒï¼šAmazon.co.jp: Cloud Native Patterns: Designing change-tolerant software (English Edition) é›»å­æ›¸ç±: Davis, Cornelia: æ´‹æ›¸Server-side service discovery patternã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³é€šä¿¡ã®é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å•ã„åˆã‚ã›ã€ã•ã‚‰ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã„ã¾ã™ã€‚ï¼ˆä¾‹ï¼‰Neflixã®Eurekaã€ãªã©â„¹ï¸ å‚è€ƒï¼šAmazon.co.jp: Cloud Native Patterns: Designing change-tolerant software (English Edition) é›»å­æ›¸ç±: Davis, Cornelia: æ´‹æ›¸Client-side service discovery patternService Discovery in Kubernetes: Combining the Best of Two Worlds03. Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿IstioãŒå®Ÿè£…ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã«ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ¡ãƒƒã‚·ãƒ¥ãŒã‚ã‚Šã€ä»Šå›ã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã¨istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒè»¸ã¨ãªã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å„ã‚³ãƒ³ãƒ†ãƒŠã«ã¤ã„ã¦è©³ã—ãè¦‹ã¦ã„ãå‰ã«ã€å…¨ä½“åƒã‚’è§£èª¬ã—ã¾ã™ã€‚kube-apiserverã¯ã€Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’etcdç­‰ã«ä¿ç®¡ã™ã‚‹ã€‚ã“ã‚Œã¯ã€Kubernetesã®é€šå¸¸ã®ä»•çµ„ã¿ã§ã‚ã‚‹ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€kube-apiserverã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã€è‡ªèº«ã«ä¿ç®¡ã™ã‚‹ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§å–å¾—ã™ã‚‹ã€‚é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚Podå†…ã®iptablesãŒã“ã‚Œã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒå—ä¿¡ã™ã‚‹ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã€å®›å…ˆPodã«ã“ã‚Œã‚’é€ä¿¡ã™ã‚‹ã€‚ä¸Šè¨˜ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®è²¬å‹™é€šã‚Šã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ï¼ˆã“ã“ã§ã¯istio-proxyã‚³ãƒ³ãƒ†ãƒŠï¼‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚ã“ã®æ™‚ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒistio-proxyã‚³ãƒ³ãƒ†ãƒŠã«ç›´æ¥çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ã€iptablesãŒistio-proxyã‚³ãƒ³ãƒ†ãƒŠã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸistio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®å•ã„åˆã‚ã›ã¨ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software DevelopmentJimmy Song - ä¸“æ³¨äºæ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼Tech-èµµåŒ–å†°çš„åšå®¢ | Zhaohuabing Blogdiscoveryã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿discoveryã‚³ãƒ³ãƒ†ãƒŠã‚’è©³ã—ãè¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€åˆ¥åIstiodã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚XDS-APIã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€XDS-APIã®ã†ã¡ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«é–¢ä¿‚ã™ã‚‹APIã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ APIã®ç¨®é¡  èª¬æ˜                                       LDS-API   Envoyã®ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                      RDS-API   Envoyã®ãƒ«ãƒ¼ãƒˆå€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                       CDS-API   Envoyã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                     EDS-API   Envoyã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã§ãã‚‹ã€‚                        ADS-API   å„XDS-APIã‹ã‚‰å–å¾—ã§ãã‚‹å®›å…ˆæƒ…å ±ã‚’æ•´ç†ã—ã¦å–å¾—ã§ãã‚‹ã€‚ discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€kube-apiserverã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã¦è‡ªèº«ã®ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿ç®¡ã—ã€å„XDS-APIã‹ã‚‰æä¾›ã—ã¾ã™ã€‚XDS-APIã¨istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®é–“ã§ã¯ã€gRPCã®åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã®æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ã¦å®›å…ˆæƒ…å ±ã‚’è¿”å´ã™ã‚‹ã ã‘ã§ãªãã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªãã¨ã‚‚ã€XDS-APIã‹ã‚‰ã‚‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦å®›å…ˆæƒ…å ±ã‚’é€ä¿¡ã—ã¾ã™ã€‚å„ç¨®XDS-APIã‹ã‚‰å€‹åˆ¥ã«å®›å…ˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ãŒã€Envoyä¸Šã§å®›å…ˆæƒ…å ±ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸æ•´åˆãŒèµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€Istioã§ã¯å®Ÿéš›ã«ã¯ADS-APIã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software Developmentistio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’è©³ã—ãè¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã§ã¯ã€pilot-agentã¨EnvoyãŒç¨¼åƒã—ã¦ã„ã¾ã™ã€‚å…ˆã»ã©istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§ADS-APIã‹ã‚‰å®›å…ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã¨èª¬æ˜ã—ã¾ã—ãŸã€‚å³å¯†ã«ã¯EnvoyãŒã€pilot-agentã‚’ä»‹ã—ã¦ã€ADS-APIã‹ã‚‰åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒé€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã™ã‚‹ã¨ã€Envoyã¯ADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã«åŸºã¥ã„ã¦ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã¾ã™ã€‚â„¹ï¸ å‚è€ƒï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software DevelopmentJimmy Song - ä¸“æ³¨äºæ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼Tech-èµµåŒ–å†°çš„åšå®¢ | Zhaohuabing Blog04. istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã®ä»•çµ„ã¿Envoyã®å‡¦ç†ã®æµã‚ŒEnvoyãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã‚’è¦‹ã¦ã„ãå‰ã«ã€Envoyã®å‡¦ç†ã®æµã‚Œã‚’è§£èª¬ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã§ã¯ã€ä»¥ä¸‹ã®ä»•çµ„ã¿ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã™ã‚‹ã€‚Envoyã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®›å…ˆæƒ…å ±ï¼ˆä¾‹ï¼šå®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç•ªå·ã€ãƒ‘ã‚¹ã€ãƒ›ã‚¹ãƒˆã€ãªã©ï¼‰ã«å¿œã˜ã¦ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’é¸ã¶ã€‚Envoyã¯ã€ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã«å¯¾å¿œã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚Envoyã§ç¢ºèªã—ãŸå®›å…ˆæƒ…å ±ã‚’ğŸ‘†ã«å½“ã¦ã¯ã‚ã¦è¦‹ã¦ã„ãã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚â„¹ï¸ å‚è€ƒï¼šAmazon.co.jp: Istio in Action (English Edition) é›»å­æ›¸ç±: Posta, Christian E., Maloku, Rinor: æ´‹æ›¸Amazon | Istio: Up and Running: Using a Service Mesh to Connect, Secure, Control, and Observe | Calcote, Lee, Butcher, Zack | Design Tools & TechniquesArchitecture Analysis of Istio: The Most Popular Service Mesh Project - Alibaba Cloud CommunityEnvoyãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã‚’è¦‹ã¦ã¿ã‚ˆã†config_dumpã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿéš›ã«Envoyã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å®›å…ˆæƒ…å ±ã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®localhost:15000/config_dumpã‹ã‚‰JSONã§å–å¾—ã§ãã¾ã™ã€‚ãŸã ã—ã€JSONã ã¨è¦‹ã«ãã„ã®ã§ã€yqã‚³ãƒãƒ³ãƒ‰ã§YAMLã«å¤‰æ›ã™ã‚‹ã¨è¦‹ã‚„ã™ããªã‚Šã¾ã™ã€‚ã‚‚ã—ãŠæ‰‹å…ƒã«IstioãŒã‚ã‚‹å ´åˆã¯ã€Envoyã«ã©ã‚“ãªå®›å…ˆæƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã€Envoyã‚’å†’é™ºã—ã¦ã¿ã¦ãã ã•ã„ğŸ‘ğŸ»$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump\" | yq -Pãƒªã‚¹ãƒŠãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒŠãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_listeners}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_listeners}\" | yq -Pâ–¼ çµæœä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚å®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„å®›å…ˆãƒãƒ¼ãƒˆç•ªå·ã«å¿œã˜ã¦ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã“ã“ã§ã¯<ä»»æ„ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>:50002ã€‚ãƒªã‚¹ãƒŠãƒ¼å€¤ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã®åå‰configs:  - \"@type\": type.googleapis.com/envoy.admin.v3.ListenersConfigDump.DynamicListener    # ãƒªã‚¹ãƒŠãƒ¼å    name: 0.0.0.0_50002    active_state:      version_info: 2022-11-24T12:13:05Z/468      listener:        \"@type\": type.googleapis.com/envoy.config.listener.v3.Listener        name: 0.0.0.0_50002        address:          socket_address:            # å—ä¿¡ã—ãŸãƒ‘ã‚±ãƒƒãƒˆã®ã†ã¡ã§ã€å®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°            address: 0.0.0.0            # å—ä¿¡ã—ãŸãƒ‘ã‚±ãƒƒãƒˆã®ã†ã¡ã§ã€å®›å…ˆãƒãƒ¼ãƒˆç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°            port_value: 50002        filter_chains:          - filter_chain_match:              transport_protocol: raw_buffer              application_protocols:                - http/1.1                - h2c            filters:              - name: envoy.filters.network.http_connection_manager                typed_config:                  \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager                  stat_prefix: outbound_0.0.0.0_50001                  rds:                    config_source:                      ads: {}                      initial_fetch_timeout: 0s                      resource_api_version: V3                    # æœ¬ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã®åå‰                    route_config_name: 50002  ...    - \"@type\": type.googleapis.com/envoy.admin.v3.ListenersConfigDump.DynamicListener  ...â„¹ï¸ å‚è€ƒï¼šAdministration interface â€” envoy 1.25.0-dev-317efa documentationConfigDump (proto) â€” envoy 1.25.0-dev-317efa documentationãƒ«ãƒ¼ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒŠãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_route_configs}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ãƒ«ãƒ¼ãƒˆå€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_route_configs}\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸãƒ«ãƒ¼ãƒˆå€¤ã®åå‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹ã‚„ãƒ›ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒˆå€¤ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆå€¤ã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰configs:  - \"@type\": type.googleapis.com/envoy.admin.v3.RoutesConfigDump.DynamicRouteConfig    version_info: 2022-11-24T12:13:05Z/468    route_config:      \"@type\": type.googleapis.com/envoy.config.route.v3.RouteConfiguration      # ãƒ«ãƒ¼ãƒˆå€¤ã®åå‰      name: 50002      virtual_hosts:        - name: bar-service.bar-namespace.svc.cluster.local:50002          # ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°          domains:            - bar-service.bar-namespace.svc.cluster.local            - bar-service.bar-namespace.svc.cluster.local:50002            - bar-service            - bar-service:50002            - bar-service.bar-namespace.svc            - bar-service.bar-namespace.svc:50002            - bar-service.bar-namespace            - bar-service.bar-namespace:50002            - 172.16.0.2            - 172.16.0.2:50002          routes:            - match:                # ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                prefix: /              route:                # æœ¬ãƒ«ãƒ¼ãƒˆã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰                cluster: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local                timeout: 0s                retry_policy:                  retry_on: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes                  num_retries: 2                  retry_host_predicate:                    - name: envoy.retry_host_predicates.previous_hosts                  host_selection_retry_max_attempts: \"5\"                  retriable_status_codes:                    - 503                max_stream_duration:                  max_stream_duration: 0s                  grpc_timeout_header_max: 0s              decorator:                operation: bar-service.bar-namespace.svc.cluster.local:50002/*                  ...                    - '@type': type.googleapis.com/envoy.admin.v3.RoutesConfigDump.DynamicRouteConfig    ...â„¹ï¸ å‚è€ƒï¼šAdministration interface â€” envoy 1.25.0-dev-317efa documentationConfigDump (proto) â€” envoy 1.25.0-dev-317efa documentationã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_active_clusters}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_active_clusters}\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆå€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®è¦ªåconfigs:  - \"@type\": type.googleapis.com/envoy.admin.v3.ClustersConfigDump.DynamicCluster    version_info: 2022-11-24T12:13:05Z/468    cluster:      \"@type\": type.googleapis.com/envoy.config.cluster.v3.Cluster      # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰      name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local      type: EDS      eds_cluster_config:        eds_config:          ads: {}          initial_fetch_timeout: 0s          resource_api_version: V3        # æœ¬ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®è¦ªå        service_name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local  ...    - \"@type\": type.googleapis.com/envoy.admin.v3.ClustersConfigDump.DynamicCluster    ...â„¹ï¸ å‚è€ƒï¼šAdministration interface â€” envoy 1.25.0-dev-317efa documentationConfigDump (proto) â€” envoy 1.25.0-dev-317efa documentationã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã¯ã€/config_dump?include_edsã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?include_eds\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¦ªåbar-podã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ3å€‹ã‚ã‚‹ãŸã‚ã€3å€‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™å…¨ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®load_balancing_weightã‚­ãƒ¼å€¤ãŒç­‰ã—ã„å ´åˆã€Envoyã¯P2Cã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã¾ã™ã€‚configs:  dynamic_endpoint_configs:    - endpoint_config:        \"@type\": type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment        # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¦ªå        cluster_name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local        endpoints:          - locality:              region: ap-northeast-1              zone: ap-northeast-1a            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.1                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1          - locality:              region: ap-northeast-1              zone: ap-northeast-1d            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.2                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1          - locality:              region: ap-northeast-1              zone: ap-northeast-1d            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.3                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1        policy:          overprovisioning_factor: 140    ...    - endpoint_config:    ...â„¹ï¸å‚è€ƒï¼šAdministration interface â€” envoy 1.25.0-dev-317efa documentationConfigDump (proto) â€” envoy 1.25.0-dev-317efa documentationSupported load balancers â€” envoy 1.25.0-dev-317efa documentationEnvoyã®å‡¦ç†ã®æµã‚Œã®ã¾ã¨ã‚ç¢ºèªã§ããŸå®›å…ˆæƒ…å ±ã‚’ã€Envoyã®å‡¦ç†ã®æµã‚Œã«å½“ã¦ã¯ã‚ã¦ã¿ã¾ã—ãŸã€‚é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆ<ä»»æ„ã®IP>/:50002ï¼‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã“ã‚Œã‚’å—ä¿¡ã—ã¾ã™ã€‚Envoyã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®›å…ˆï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç•ªå·ã€ãƒ‘ã‚¹ï¼‰ã‹ã‚‰Podã®ãƒªã‚¹ãƒŠãƒ¼å€¤ï¼ˆ0.0.0.0_50002ï¼‰ã‚’é¸ã¶ã€‚Envoyã¯ã€ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ãPodã®ãƒ«ãƒ¼ãƒˆå€¤ï¼ˆ50002ï¼‰ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãPodã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ï¼ˆoutbound|50002|v1|bar-service.bar-namespace.svc.cluster.localï¼‰ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãPodã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ï¼ˆ11.0.0.X/:80ï¼‰ã‚’é¸ã¶ã€‚Envoyã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®å®›å…ˆã«Podã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®å†’é™ºã¯ä»¥ä¸Šã§ã™ã€‚05. ãŠã‚ã‚Šã«ä»Šå›ã€Istioã®æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã€ã®ä»•çµ„ã¿ã‚’ã€Envoyã‚’äº¤ãˆãªãŒã‚‰å¸ƒæ•™ã—ã¾ã—ãŸã€‚ã‚‚ã‚Šã‚‚ã‚Šã§ã—ãŸãŒã€æœ€å¾Œã¾ã§ãŠä»˜ãåˆã„ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã“ã“ã¾ã§è¦‹ã¦ã„ãŸã ã„ãŸãã“ã®ã‚ãªãŸã€ç‰‡è¶³ãŒæ²¼ã«æµ¸ã‹ã£ã¦ã¾ã™ğŸ˜è¬è¾3-shake SRE Tech Talk ã§ã®ç™ºè¡¨å‰å¾Œã«ã€ä»¥ä¸‹ã®æ–¹ã€…ã«ã€ç™ºè¡¨å†…å®¹ã«ã¤ã„ã¦åŠ©è¨€ã‚’ã„ãŸã ãã¾ã—ãŸã€‚@ido_kara_deru ã•ã‚“@yosshi_ ã•ã‚“@yteraoka ã•ã‚“ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼‰ã¾ãŸã€ä»Šå›ã® 3-shake Advent Calender 2022 ã¯ã€ä»¥ä¸‹ã®æ–¹ã€…ã«ä¼ç”»ã„ãŸã ãã¾ã—ãŸã€‚@jigyakkuma_ ã•ã‚“@nwiizo ã•ã‚“ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ï¼‰çš†æ§˜ã«æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ğŸ™‡ğŸ»â€â™‚ï¸","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2022/12/25/060000","isoDate":"2022-12-24T21:00:00.000Z","dateMiliSeconds":1671915600000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"}]},"__N_SSG":true}