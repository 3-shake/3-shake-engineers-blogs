<!DOCTYPE html><html lang="ja"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon shortcut" type="image/png" href="https://blog.3-shake.com/logo.png"/><title>Hiroki Hasegawa | 3-shake Engineers&#x27; Blogs</title><meta property="og:title" content="Hiroki Hasegawa"/><meta property="og:url" content="https://blog.3-shake.com/members/hiroki-hasegawa"/><meta name="twitter:card" content="summary_large_image"/><meta property="og:site" content="3-shake Engineers&#x27; Blogs"/><meta property="og:image" content="https://blog.3-shake.com/og.png"/><link rel="canonical" href="https://blog.3-shake.com/members/hiroki-hasegawa"/><meta name="next-head-count" content="10"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/ca0df06cc4f85fc8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ca0df06cc4f85fc8.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-b8f8d6679aaa5f42.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-b671ab60a2eabb59.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6a10dd35a87df0b2.js" defer=""></script><script src="/_next/static/chunks/983-6c7e1774f828d024.js" defer=""></script><script src="/_next/static/chunks/pages/members/%5Bid%5D-fa4563d96c58aa0a.js" defer=""></script><script src="/_next/static/tGx2r-mCxkIqn2yX3IufJ/_buildManifest.js" defer=""></script><script src="/_next/static/tGx2r-mCxkIqn2yX3IufJ/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap">@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjZ0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsjr0C4k.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:normal;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memSYaGs126MiZpBA-UvWbX2vVnXBbObj2OVZyOOSr4dVJWUgsg-1y4k.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5vAA.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Me5g.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9vAA.woff) format('woff')}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlvAA.woff) format('woff')}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:500;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSKmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSumu0SC55K5gw.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSOmu0SC55K5gw.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSymu0SC55K5gw.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS2mu0SC55K5gw.woff2) format('woff2');unicode-range:U+0590-05FF,U+200C-2010,U+20AA,U+25CC,U+FB1D-FB4F}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSCmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTSGmu0SC55K5gw.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Open Sans';font-style:normal;font-weight:700;font-stretch:100%;font-display:swap;src:url(https://fonts.gstatic.com/s/opensans/v35/memvYaGs126MiZpBA-UvWbX2vVnXBbObj2OVTS-mu0SC55I.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:300;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmSU5fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu72xKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu5mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7mxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7WxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu7GxKKTU1Kvnz.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxKKTU1Kg.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:500;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmEU9fBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCRc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfABc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCBc4AMP6lbBP.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfBxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfCxc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfChc4AMP6lbBP.woff2) format('woff2');unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Roboto';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/roboto/v30/KFOlCnqEu92Fr1MmWUlfBBc4AMP6lQ.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next"><header class="site-header"><div class="content-wrapper"><div class="site-header__inner"><a class="site-header__logo-link" href="/"><img src="/logo.svg" alt="3-shake Engineers&#x27; Blogs" class="site-header__logo-img"/><span class="site-header__logo-text">3-shake<br/>Engineers&#x27; Blogs</span></a><div class="site-header__links"><a class="site-header__link" href="/feed.xml">RSS</a><a href="https://3-shake.com/category/recruit/" class="site-header__link">Recruit</a><a href="https://3-shake.com/" class="site-header__link">Company</a></div></div></div></header><section class="member"><div class="content-wrapper"><header class="member-header"><div class="member-header__avatar"><img src="/avatars/hirokihasegawa.png" alt="Hiroki Hasegawa" width="100" height="100" class="member-header__avatar-img"/></div><h1 class="member-header__name">Hiroki Hasegawa</h1><p class="member-header__bio">Let me know your favorite technology! âœŒï¸</p><div class="member-header__links"><a href="https://twitter.com/Hiroki__IT" class="member-header__link"><img src="/icons/twitter.svg" alt="Twitterã®ãƒ¦ãƒ¼ã‚¶ãƒ¼@Hiroki__IT" width="22" height="22"/></a><a href="https://github.com/hiroki-it" class="member-header__link"><img src="/icons/github.svg" alt="GitHubã®ãƒ¦ãƒ¼ã‚¶ãƒ¼@hiroki-it" width="22" height="22"/></a><a href="https://hiroki-it.github.io/tech-notebook/" class="member-header__link"><img src="/icons/link.svg" alt="ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ãƒªãƒ³ã‚¯" width="22" height="22"/></a></div></header><div class="member-posts-container"><div class="post-list"><article class="post-link"><a class="post-link__author" href="/members/hiroki-hasegawa"><img src="/avatars/hirokihasegawa.png" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">Hiroki Hasegawa</div><time dateTime="2023-05-02T05:42:57.000Z" class="post-link__date">24 days ago</time></div></a><a href="https://hiroki-hasegawa.hatenablog.jp/entry/2023/05/02/145115" class="post-link__main-link"><h2 class="post-link__title">ã€ArgoCDğŸ™ã€‘ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=hiroki-hasegawa.hatenablog.jp" width="14" height="14" class="post-link__site-favicon"/>hiroki-hasegawa.hatenablog.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/hiroki-hasegawa"><img src="/avatars/hirokihasegawa.png" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">Hiroki Hasegawa</div><time dateTime="2023-02-26T11:25:48.000Z" class="post-link__date">3 months ago</time></div></a><a href="https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202548" class="post-link__main-link"><h2 class="post-link__title">ã€Istioâ›µï¸ã€‘Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=hiroki-hasegawa.hatenablog.jp" width="14" height="14" class="post-link__site-favicon"/>hiroki-hasegawa.hatenablog.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/hiroki-hasegawa"><img src="/avatars/hirokihasegawa.png" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">Hiroki Hasegawa</div><time dateTime="2023-01-14T13:38:15.000Z" class="post-link__date">4 months ago</time></div></a><a href="https://hiroki-hasegawa.hatenablog.jp/entry/2023/01/14/223815" class="post-link__main-link"><h2 class="post-link__title">ã€Istioâ›µï¸ã€‘Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=hiroki-hasegawa.hatenablog.jp" width="14" height="14" class="post-link__site-favicon"/>hiroki-hasegawa.hatenablog.jp</div></a></article><article class="post-link"><a class="post-link__author" href="/members/hiroki-hasegawa"><img src="/avatars/hirokihasegawa.png" class="post-link__author-img" width="35" height="35"/><div class="post-link__author-name"><div class="post-link__author-name">Hiroki Hasegawa</div><time dateTime="2022-12-24T21:00:00.000Z" class="post-link__date">5 months ago</time></div></a><a href="https://hiroki-hasegawa.hatenablog.jp/entry/2022/12/25/060000" class="post-link__main-link"><h2 class="post-link__title">ã€Istioâ›µï¸ã€‘Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿</h2><div class="post-link__site"><img src="https://www.google.com/s2/favicons?domain=hiroki-hasegawa.hatenablog.jp" width="14" height="14" class="post-link__site-favicon"/>hiroki-hasegawa.hatenablog.jp</div></a></article></div></div></div></section><footer class="site-footer"><div class="content-wrapper"><p>Â© <!-- -->3-shake Inc.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"member":{"id":"hiroki-hasegawa","name":"Hiroki Hasegawa","role":"SRE","bio":"Let me know your favorite technology! âœŒï¸","avatarSrc":"/avatars/hirokihasegawa.png","sources":["https://hiroki-hasegawa.hatenablog.jp/feed"],"includeUrlRegex":"","twitterUsername":"Hiroki__IT","githubUsername":"hiroki-it","websiteUrl":"https://hiroki-it.github.io/tech-notebook/"},"postItems":[{"title":"ã€ArgoCDğŸ™ã€‘ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿","contentSnippet":"01. ã¯ã˜ã‚ã«02. æ¦‚è¦ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£â–¼ ãƒ¬ã‚¤ãƒ¤ãƒ¼â–¼ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•çµ„ã¿ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘ã€ï¼—ã€‘ã€ï¼˜ã€‘ã€ï¼™ã€‘ã€ï¼‘ï¼ã€‘03. repo-serverrepo-serverã¨ã¯ä»•çµ„ã¿ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘ã€ï¼—ã€‘04. application-controllerã€redis-serverapplication-controllerã¨ã¯redis-serverã¨ã¯ä»•çµ„ã¿ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘ã€ï¼—ã€‘05. dex-serverdex-serverã¨ã¯ä»•çµ„ã¿ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘06. argocd-server (argocd-apiserver)argocd-serverã¨ã¯ä»•çµ„ã¿ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘ã€ï¼—ã€‘ã€ï¼˜ã€‘ã€ï¼™ã€‘ã€ï¼‘ï¼ã€‘07. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã¾ã¨ã‚08. ãŠã‚ã‚Šã«è¬è¾01. ã¯ã˜ã‚ã«ãƒ­ã‚±ãƒƒãƒˆã«ä¹—ã‚‹Argoãã‚“ã®ãƒ„ãƒ©ãŒè…¹ç«‹ã¤ã‚ãƒ¼ã€‚ã•ã¦æœ€è¿‘ã®æ¥­å‹™ã§ã€å…¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãŒå…±é€šåŸºç›¤ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ArgoCDã¨AWS EKS Clusterã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ãƒªãƒ—ãƒ¬ã‚¤ã‚¹ã—ã¦ã„ã¾ã™ã€‚æ¡ç”¨ã—ãŸè¨­è¨ˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ç´¹ä»‹ã‚‚å…¼ã­ã¦ã€ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿ã‚’è¨˜äº‹ã§è§£èª¬ã—ã¾ã—ãŸğŸš€ArgoCDã¯ã€kubectlã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ç¾åœ¨ã«è‡³ã‚‹ã¾ã§ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¯å¤‰é·ãŒã‚ã‚Šã€ä»Šå›ç´¹ä»‹ã™ã‚‹ã®ã¯åŸ·ç­†æ™‚ç‚¹ (2023/05/02) æ™‚ç‚¹ã§æœ€æ–°ã® 2.6 ç³»ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚„ä»•çµ„ã¿ã¯ã‚‚ã¡ã‚ã‚“ã€å€‹ã€…ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å®Ÿè£…ã«ã‚‚ã¡ã‚‡ã£ã¨ã ã‘è¨€åŠã—ã¾ã™ã€‚ãã‚Œã§ã¯ã€ArgoCDã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—02. æ¦‚è¦ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£â–¼ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãšã¯ã€ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã©ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ArgoCDå…¬å¼ã‹ã‚‰ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›³ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚å›³ã‹ã‚‰ã€æ¬¡ã®ã‚ˆã†ãªã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ğŸ‘‡ä¸‹ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼å‘ãã«ã—ã‹ä¾å­˜æ–¹å‘ãŒãªãã€ä¾‹ãˆã°ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã§ä¾å­˜æ€§ã¯é€†è»¢ã•ã›ã¦ã„ãªã„ã€‚ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¨®é¡ (UIã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ã‚¤ãƒ³ãƒ•ãƒ©) ã¨ãã‚Œã‚‰ã®ä¾å­˜æ–¹å‘ã‹ã‚‰ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã‚‹ã€‚ç‰¹ã«ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç‹¬ç«‹ã—ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†å‰²ã•ã‚Œã¦ãŠã‚Šã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã€‚â†ªï¸ï¼šargo-cd/components.md at master Â· argoproj/argo-cd Â· GitHubArgoCDã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€æ©Ÿèƒ½å˜ä½ã®åˆ†å‰²æ–¹æ³•ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã¨æ¨æ¸¬ã—ã¦ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ†å‰²æ–¹æ³•ã«ã¯å¤§å°ã„ãã¤ã‹ã®ç¨®é¡ãŒã‚ã‚Šã€å¢ƒç•Œä»˜ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§åˆ†å‰²ã™ã‚‹ã“ã¨ãŒãƒ™ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ğŸ˜(å¢ƒç•Œä»˜ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¤ã„ã¦ã‚‚ã€ã¡ã‚ƒã‚“ã¨è¨˜äº‹ã‚’æŠ•ç¨¿ã—ãŸã„...)æ©Ÿèƒ½å˜ä½ã«ã‚ˆã‚‹åˆ†å‰²ã¯ã€å¢ƒç•Œä»˜ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ãã‚Œã‚ˆã‚Šã‚‚ç²’åº¦ãŒå°ã•ããªã‚Šã¾ã™ã€‚â†ªï¸ï¼šãƒ¢ãƒãƒªã‚¹ã‹ã‚‰ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¸ â€•ãƒ¢ãƒãƒªã‚¹ã‚’é€²åŒ–ã•ã›ã‚‹å®Ÿè·µç§»è¡Œã‚¬ã‚¤ãƒ‰ | Sam Newman, å³¶ç”° æµ©äºŒ |æœ¬ | é€šè²© | AmazonArgoCDã§ã¯ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆå›³ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›³ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå›³ã§ã¯ã€ä¾å­˜æ–¹å‘ (ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã„ãšã‚Œã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã®ã‹) ã«ç€ç›®ã§ãã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã‚Œã¯ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜æ–¹å‘ã‚’è¦–è¦šåŒ–ã™ã‚‹ãŸã‚ã«æœ‰åŠ¹ãªUMLå›³ã§ã™ğŸ™†ğŸ»â€â†ªï¸ï¼šComponent Diagrams - Code With Engineering Playbookâ–¼ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¬¡ã«ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç¨®é¡ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ArgoCDã®å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒçµ„ã¿åˆã‚ã•ã‚Šã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®è‡ªå‹•çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿç¾ã—ã¾ã™ã€‚ArgoCD (2.6ç³») ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã„ãã¤ã‹ã‚ã‚Šã€ä¸»è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ç¨®é¡ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ                    ãƒ¬ã‚¤ãƒ¤ãƒ¼               æ©Ÿèƒ½                                                                                                                                                                                                             argocd-server (argocd-apiserver)  UI / ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³  ã¿ã‚“ãªãŒã‚ˆãçŸ¥ã‚‹ArgoCDã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚ã¾ãŸã€ArgoCDã®APIã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚ç¾åœ¨ã€è¤‡æ•°ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è²¬å‹™ã‚’æŒã£ã¦ãŠã‚Šã€å°†æ¥çš„ã«UIã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ç•°ãªã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†å‰²ã•ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚  application-controller            ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³           Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã¾ãŸã€ArgoCDç³»ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚                                                                                            repo-server                       ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³           ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ/ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚ã¾ãŸã€ã‚¯ãƒ­ãƒ¼ãƒ³ã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚                                                                                                        redis-server                      ã‚¤ãƒ³ãƒ•ãƒ©               application-controllerã®å‡¦ç†çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿ç®¡ã—ã¾ã™ã€‚                                                                                                                                                       dex-server                        ã‚¤ãƒ³ãƒ•ãƒ©               SSOã‚’æ¡ç”¨ã™ã‚‹å ´åˆã«ã€argocd-serverã®ä»£ã‚ã‚Šã«èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã“ã‚Œã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€argocd-serverä¸Šã®èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å§”è­²ã§ãã¾ã™ã€‚                             â†ªï¸ï¼šAmazon | GitOps and Kubernetes: Continuous Deployment with Argo CD, Jenkins X, and Flux | Yuen, Billy, Matyushentsev, Alexander, Ekenstam, Todd, Suen, Jesse | PMP Examä»•çµ„ã¿ãã‚Œã§ã¯ã€ArgoCDã¯ã€ã©ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã“ã“ã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€… (ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã‚’ç®¡ç†ã™ã‚‹ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢) ã¯ã€ArgoCDã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä»‹ã—ã¦ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãšã¯ã€æ¦‚è¦ã‚’èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚ã€ï¼‘ã€‘ArgoCDã®Clusterä¸Šã§ã€repo-serverãŒãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ/ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚ã€ï¼’ã€‘application-controllerã¯ã€repo-serverã‹ã‚‰ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚ã€ï¼“ã€‘application-controllerã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã®ç¾çŠ¶ã‚’ç¢ºèªã—ã¾ã™ã€‚ã€ï¼”ã€‘application-controllerã¯ã€å‡¦ç†çµæœã‚’redis-serverã«ä¿ç®¡ã—ã¾ã™ã€‚ã€ï¼•ã€‘argocd-serverã¯ã€redis-serverã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—ã—ã¾ã™ã€‚ã€ï¼–ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ã¯ã€argocd-serverã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã€ï¼—ã€‘argocd-serverã¯ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«èªå¯ãƒ•ã‚§ãƒ¼ã‚ºã‚’å§”è­²ã™ã‚‹ãŸã‚ã«ã€dex-serverã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚ã€ï¼˜ã€‘dex-serverã¯ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã€ã“ã‚Œã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚ã€ï¼™ã€‘argocd-serverã§èªå¯ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ã¯èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã«å¿œã˜ã¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ“ä½œã§ãã¾ã™ã€‚ã€ï¼‘ï¼ã€‘application-controllerã¯ã€Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿ã‚’ã–ã£ãã‚Šç´¹ä»‹ã—ã¾ã—ãŸã€‚ãŸã ã“ã‚Œã ã¨å…¨ãé¢ç™½ããªã„ã®ã§ã€å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å…·ä½“çš„ãªå‡¦ç†ã¨ã€å„ã€…ãŒã©ã®ã‚ˆã†ã«é€šä¿¡ã—ã¦ã„ã‚‹ã®ã‹ã‚’èª¬æ˜ã—ã¾ã™âœŒï¸03. repo-serverrepo-serverã¨ã¯ã¾ãšã¯ã€ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ã‚‹repo-serverã§ã™ã€‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ/ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒª (ä¾‹ï¼šGiHubã€GitHub Pagesã€Artifact Hubã€AWS ECRã€Artifact Registryã€ãªã©) ã‹ã‚‰ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚repo-serverã‚’æŒã¤Podã«ã¯ã€ä»–ã«è»½é‡ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ãªã‚‹InitContainerã¨ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ (cmp-server) ãŒãŠã‚Šã€ãã‚Œãã‚Œæ©Ÿèƒ½ãŒåˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ğŸ‘ä»•çµ„ã¿ã€ï¼‘ã€‘repo-serverã®èµ·å‹•æ™‚ã«ã€InitContainerã§ãŠå¥½ããªãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ« (Helmã€Kustomizeã€ãªã©) ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (helm-secretsã€KSOPSã€SOPSã€argocd-vault-pluginã€ãªã©) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã¾ãŸã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®cmp-serverã§ã¯èµ·å‹•æ™‚ã«/var/run/argocd/argocd-cmp-serverã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€InitContainer (ã“ã“ã§ã¯copyutilã‚³ãƒ³ãƒ†ãƒŠ) ã‚’ä½¿ç”¨ã—ã¦ã€ArgoCDã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰argocd-cliã®ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚repo-serverã®ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€ArgoCDã§ä½¿ã„ãŸã„ãƒ„ãƒ¼ãƒ« (Helmã€SOPSã€helm-secrets) ã‚’InitContainerã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™ã€‚apiVersion: v1kind: Podmetadata:  name: argocd-repo-server  namespace: argocdspec:  containers:    - name: repo-server      image: quay.io/argoproj/argocd:latest  initContainers:    # Helmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹InitContainer    - name: helm-installer      image: alpine:latest      command:        - /bin/sh        - -c      args:        - |          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†      volumeMounts:        - mountPath: /custom-tools          name: custom-tools    # SOPSã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹InitContainer    - name: sops-installer      image: alpine:latest      command:        - /bin/sh        - -c      args:        - |          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†      volumeMounts:        - mountPath: /custom-tools          name: custom-tools    # helm-secretsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹InitContainer    - name: helm-secrets-installer      image: alpine:latest      command:        - /bin/sh        - -c      args:        - |          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†      volumeMounts:        - mountPath: /helm-working-dir/plugins          name: helm-working-dir    ...    # cmp-serverã«argocd-cliã®ãƒã‚¤ãƒŠãƒªã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹InitContainer    - name: copyutil      image: quay.io/argoproj/argocd:latest      command:        - cp        - -n        - /usr/local/bin/argocd        - /var/run/argocd/argocd-cmp-server      volumeMounts:        - name: var-files          mountPath: /var/run/argocd  # Podã®å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ   volumes:    - name: custom-tools      emptyDir: {}    - name: var-files      emptyDir: {}â†ªï¸ï¼šCustom Tooling - Argo CD - Declarative GitOps CD for KubernetesArgoCDã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ (quay.io/argoproj/argocd) ã«ã¯ã€ã„ãã¤ã‹ã®ãƒ„ãƒ¼ãƒ« (ä¾‹ï¼šHelmã€Kustomizeã€Ksã€Jsonnetã€ãªã©) ã®æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‰ã‹ã˜ã‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®cmp-serverã‚’æ¡ç”¨ã—ãªã„å ´åˆã¯ã€ã“ã‚Œã‚‰ã®ãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚åå¯¾ã«ã€cmp-serverã‚’æ¡ç”¨ã™ã‚‹å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã«ãªã‚Šã¾ã™ğŸ™‡ğŸ» å…¬å¼ãŒã€æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…¬é–‹ã—ã¦ãã‚Œã‚‹ã®ã‚’å¾…ã¡ãŸã„ã¨ã“ã‚ãªã®ã§ã™ãŒã€ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚ã§ããªãã¯ãªã„ã§ã™ğŸ™†ğŸ»â€# ArgoCDã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«å†…è”µã•ã‚ŒãŸHelmã®æ¨å¥¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹$ curl -s https://raw.githubusercontent.com/argoproj/argo-cd/\u003cãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°\u003e/hack/tool-versions.sh \\    | grep helm3_version | sed -e 's/^[^=]*=//'â†ªï¸ï¼šargo-cd/tool-versions.sh at master Â· argoproj/argo-cd Â· GitHubKustomizeã«ã‚ˆã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆä½œæˆã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã§ã¯ãªãrepo-serverã§å®Ÿè¡Œã—ãŸæ–¹ãŒè‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ (Helmã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã§å•é¡Œãªã„ã§ã™)ã€‚åŸ·ç­†æ™‚ç‚¹ (2023/05/02) ã§ã¯ã€ArgoCDã¨KustomizeãŒå¯†ã«çµåˆã—ã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€ArgoCDä¸Šã®Kustomizeç³»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯repo-serverã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚ç„¡ç†ã‚„ã‚Šã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã§Kustomizeã‚’å®Ÿè¡Œã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ArgoCDã®æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç„¡è¦–ã—ãŸå®Ÿè£…ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã€Kustomizeã ã‘ã¯repo-serverã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ğŸ˜¢ã€ï¼’ã€‘repo-serverã¯ã€Secret (argocd-repo-creds) ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã®èªè¨¼æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚argocd-repo-credsã§ã¯ãƒªãƒã‚¸ãƒˆãƒªã®èªè¨¼æƒ…å ±ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚æŒ‡å®šã—ãŸæ–‡å­—åˆ—ã‹ã‚‰å§‹ã¾ã‚‹ (æœ€é•·ä¸€è‡´) URLã‚’æŒã¤ãƒªãƒã‚¸ãƒˆãƒªã«æ¥ç¶šã™ã‚‹å ´åˆã«ã€ãã‚Œã‚‰ã®æ¥ç¶šã§èªè¨¼æƒ…å ±ã‚’ä¸€æ‹¬ã—ã¦é©ç”¨ã§ãã¾ã™ã€‚argocd-repo-credsã®ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã®SSHå…¬é–‹éµèªè¨¼ã‚’æ¡ç”¨ã—ã€argocd-repo-credsã«å…±é€šã®ç§˜å¯†éµã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚apiVersion: v1kind: Secretmetadata:  name: argocd-repo-creds-github  namespace: argocd  labels:    argocd.argoproj.io/secret-type: repo-credstype: Opaquedata:  type: git  url: https://github.com/hiroki-hasegawa  # ç§˜å¯†éµ  sshPrivateKey: |    MIIC2 ...ã‚ã¨ã¯ã€å„ãƒªãƒã‚¸ãƒˆãƒªã®Secret (argocd-repo) ã«URLã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚ã™ã‚‹ã¨ã€å…ˆã»ã©ã®argocd-repo-credsã®URLã«æœ€é•·ä¸€è‡´ã™ã‚‹URLã‚’æŒã¤Secretã«ã¯ã€ä¸€æ‹¬ã—ã¦ç§˜å¯†éµãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚# foo-repositoryã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®argocd-repoapiVersion: v1kind: Secretmetadata:  namespace: argocd  name: foo-argocd-repo  labels:    argocd.argoproj.io/secret-type: repositorytype: Opaquedata:  # èªè¨¼æƒ…å ±ã¯è¨­å®šã—ãªã„ã€‚  # ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªå  name: bar-repository  # https://github.com/hiroki-hasegawa ã«æœ€é•·ä¸€è‡´ã™ã‚‹ã€‚  url: https://github.com/hiroki-hasegawa/bar-chart.git---# baz-repositoryã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ãŸã‚ã®argocd-repoapiVersion: v1kind: Secretmetadata:  namespace: foo  name: baz-argocd-repo  labels:    argocd.argoproj.io/secret-type: repositorytype: Opaquedata:  # èªè¨¼æƒ…å ±ã¯è¨­å®šã—ãªã„ã€‚  # ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªå  name: baz-repository  # https://github.com/hiroki-hasegawa ã«æœ€é•·ä¸€è‡´ã™ã‚‹ã€‚  url: https://github.com/hiroki-hasegawa/baz-chart.gitâ†ªï¸ï¼šDeclarative Setup - Argo CD - Declarative GitOps CD for Kubernetesã€ï¼“ã€‘repo-serverã¯ã€èªè¨¼æƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ã€ãƒªãƒã‚¸ãƒˆãƒªã«git cloneã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚å–å¾—ã—ãŸã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ã€/tmp/_argocd-repoãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«UUIDã®åå‰ã§ä¿ç®¡ã—ã¾ã™ã€‚ã¾ãŸã€ãƒªãƒã‚¸ãƒˆãƒªã®å¤‰æ›´ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸå ´åˆã¯git fetchã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚# ã‚¯ãƒ­ãƒ¼ãƒ³ãŒä¿ç®¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹$ kubectl -it exec argocd-repo-server \\    -c repo-server \\    -n foo \\    -- bash -c \"ls /tmp/_argocd-repo/\u003cURLã«åŸºã¥ãUUID\u003e\"# ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«Chart.yaml  README.md  templates  values.yamlâ†ªï¸ï¼šcustom repo-server - where is the local cache kept? Â· argoproj/argo-cd Â· Discussion #9889 Â· GitHub2.3ä»¥å‰ã§ã¯ã€repo-serverã¯/tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã«URLã«åŸºã¥ãåå‰ã§ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä¿ç®¡ã—ã¾ã™ã€‚$ kubectl -it exec argocd-repo-server \\    -c repo-server \\    -n foo \\    -- bash -c \"ls /tmp/https___github.com_hiroki-hasegawa_foo-repository\"# ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«Chart.yaml  README.md  templates  values.yamlã€ï¼”ã€‘repo-serverã¯ã€Volumeä¸Šã®Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã‚’ä»‹ã—ã¦ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ (cmp-server) ã«ã‚ˆã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å®Ÿè¡Œã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿä½“ã¯.sockãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚$ kubectl exec -it argocd-repo-server -c foo-plugin-cmp-server\\    -- bash -c \"ls /home/argocd/cmp-server/plugins/\"foo-plugin.sockUnixã‚½ã‚±ãƒƒãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã€åŒã˜OSä¸Šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ä»‹ã—ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥çš„ã«é€å—ä¿¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚Unixã‚½ã‚±ãƒƒãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€åŒã˜VolumeãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã®ãƒ—ãƒ­ã‚»ã‚¹é–“ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’é€å—ä¿¡ã§ãã¾ã™ğŸ‘â†ªï¸ï¼šASCII.jpï¼šUnixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆ (1/2)ã€ï¼•ã€‘cmp-serverã¯ã€æš—å·åŒ–ã‚­ãƒ¼ (ä¾‹ï¼šAWS KMSã€Google CKMã€ãªã©) ã‚’ä½¿ç”¨ã—ã¦Secretã‚¹ãƒˆã‚¢ (AWS SecretManagerã€Google SecretManagerã€SOPSã€Vaultã€ãªã©) ã®æš—å·åŒ–å¤‰æ•°ã‚’å¾©å·åŒ–ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒHTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ä½¿ç”¨ã‚’æ±‚ã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚cmp-serverã«è»½é‡ãªã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã¨ã€/etc/sslãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (OSã«ã‚ˆã‚‹)ã€€ã«SSLè¨¼æ˜æ›¸ãŒç„¡ãã€cmp-serverãŒHTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã¯ã€ãŠå¥½ããªæ–¹æ³•ã§è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ğŸ‘apiVersion: v1kind: Podmetadata:  name: argocd-repo-server  namespace: foospec:  containers:    - name: repo-server      image: quay.io/argoproj/argocd:latest  ...    # ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®cmp-server    - name: helm-secrets-cmp-server      image: ubuntu:latest      ...      volumeMounts:        # ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒAWS KMSã‚’ä½¿ç”¨ã™ã‚‹æ™‚ã«HTTPSãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€SSLè¨¼æ˜æ›¸ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: certificate          mountPath: /etc/ssl  ...  initContainers:    - name: certificate-installer      image: ubuntu:latest      command:        - /bin/sh        - -c      args:        - |          apt-get update -y          # ãƒ«ãƒ¼ãƒˆè¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹          apt-get install -y ca-certificates          # è¨¼æ˜æ›¸ã‚’æ›´æ–°ã™ã‚‹          update-ca-certificates      volumeMounts:        - mountPath: /etc/ssl          name: certificate  volumes:    - name: certificate      emptyDir: {}ã€ï¼–ã€‘cmp-serverãŒãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ« (ä¾‹ï¼šHelmã€Kustomize) ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹æ™‚ã«ã€ã“ã‚Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (helm-secretsã€argocd-vault-pluginã€ãªã©) ã‚’ä½¿ç”¨ã—ãŸã„ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ä½œæˆæ™‚ã®è¿½åŠ å‡¦ç†ã¨ã—ã¦ã€ConfigMapé…ä¸‹ã®ConfigManagementPluginã§ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦helm-secretsã‚’æ¡ç”¨ã—ã€helm secrets templateã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’å®šç¾©ã—ã¾ã™ã€‚apiVersion: v1kind: ConfigMapmetadata:  name: argocd-cmp-cm  namespace: foodata:  helm-secrets-plugin.yaml: |    apiVersion: argoproj.io/v1alpha1    kind: ConfigManagementPlugin    metadata:      namespace: foo      name: helm-secrets    spec:      generate:        command:          - /bin/bash          - -c        args:          - |            set -o pipefail            helm secrets template -f $ARGOCD_ENV_SECRETS -f $ARGOCD_ENV_VALUES -n $ARGOCD_APP_NAMESPACE $ARGOCD_APP_NAME .  foo-plugin.yaml: |    ...è¤‡æ•°ã®ConfigManagementPluginã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ã€å„ConfigManagementPluginã§ç•°ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã¨ã—ã€ConfigMapã§ç®¡ç†ã™ã‚‹ã¨è‰¯ã„ã§ã™ğŸ‘ã€ï¼—ã€‘cmp-serverã¯ã€ã‚’å®Ÿè¡Œã—ã€Secretã‚’å«ã‚€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ConfigMapé…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’plugin.yamlã®åå‰ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸã€å…ˆã»ã©ã®Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆã®.sockãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã€ cmp-serverãŒãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®å„ç¨®ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãƒã‚¦ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€helm-secretsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ (helm-secrets-cmp-server) ã‚’ä½œæˆã—ã¾ã™ã€‚apiVersion: v1kind: Podmetadata:  name: argocd-repo-serverspec:  containers:    # repo-server    - name: repo-server      image: quay.io/argoproj/argocd:latest    ...    # helm-secretsã®cmp-server    - name: helm-secrets-cmp-server      # ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã¯è»½é‡ã«ã™ã‚‹      image: ubuntu:latest      command:        - /var/run/argocd/argocd-cmp-server      env:        # helmãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å ´æ‰€ã‚’è¨­å®šã™ã‚‹        - name: HELM_PLUGINS          value: /helm-working-dir/plugins      securityContext:        runAsNonRoot: true        runAsUser: 999      volumeMounts:        # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: tmp          mountPath: /tmp        # ConfigManagementPluginã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (helm-secrets.yaml) ã‚’ \"plugin.yaml\" ã®åå‰ã§ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: argocd-cmp-cm          mountPath: /home/argocd/cmp-server/config/plugin.yaml          subPath: helm-secrets.yaml        # ã‚³ãƒ³ãƒ†ãƒŠé–“ã§é€šä¿¡ã™ã‚‹ãŸã‚ã®Unixãƒ‰ãƒ¡ã‚¤ãƒ³ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: plugins          mountPath: /home/argocd/cmp-server/plugins        # ä»»æ„ã®ãƒ„ãƒ¼ãƒ«ã®ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: custom-tools          mountPath: /usr/local/bin        # helmãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ãƒã‚¤ãƒŠãƒªã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹        - name: helm-working-dir          mountPath: /helm-working-dir/plugins      ...  # Podã®å…±æœ‰ãƒœãƒªãƒ¥ãƒ¼ãƒ   volumes:    # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’å«ã‚€    - name: tmp      emptyDir: {}    # Helmãªã©ã®ä»»æ„ã®ãƒ„ãƒ¼ãƒ«ã‚’å«ã‚€    - name: custom-tools      emptyDir: {}    # helmãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å«ã‚€    - name: helm-working-dir      emptyDir: {}ArgoCDã®v2.6ã§ã¯ã€ConfigManagementPluginã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’/home/argocd/cmp-server/configãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€plugin.yamlã®åå‰ã§ãƒã‚¦ãƒ³ãƒˆã—ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚ã“ã‚Œã¯ã€cmp-serverã®èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ (/var/run/argocd/argocd-cmp-server) ãŒplugin.yamlã®åå‰ã—ã‹æ‰±ãˆãªã„ãŸã‚ã§ã™ã€‚ä»Šå¾Œã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§æ”¹å–„ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ãŒã€v2.6ã§ã¯ã€ConfigManagementPluginã®æ•°ã ã‘cmp-serverãŒå¿…è¦ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ğŸ™‡ğŸ»â€ä»Šå›ã¯è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ãŒã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®Secretã‚¹ãƒˆã‚¢ (ä¾‹ï¼šAWS SecretManagerã€Google SecretManagerã€ãªã©) ã®å¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€Secretã®ãƒ‡ãƒ¼ã‚¿æ³¨å…¥ãƒ„ãƒ¼ãƒ«ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ (ç‰¹ã«argocd-vault-plugin) ã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®å ´åˆã€ä»£ã‚ã‚Šã«Secretsã‚¹ãƒˆã‚¢CSIãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã‚„ExternalSecretsOperatorã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰å¤‰æ•°ã‚’å–å¾—ã—ã€ã“ã‚Œã‚’Secretã«ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ³¨å…¥ã—ã¦ãã‚Œã¾ã™ğŸ™‡ğŸ»â€â†ªï¸ï¼šHow to manage Kubernetes secrets with GitOps? | Akuity04. application-controllerã€redis-serverapplication-controllerã¨ã¯ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ã‚‹application-controllerã§ã™ã€‚Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã¾ãŸã€ArgoCDç³»ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚redis-serverã¨ã¯ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ã‚‹redis-serverã§ã™ã€‚application-controllerã®å‡¦ç†çµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿ç®¡ã—ã¾ã™ã€‚ä»•çµ„ã¿ã€ï¼‘ã€‘ArgoCDç”¨Clusterã®ç®¡ç†è€…ã¯ã€Clusterã«ArgoCDç³»ã®ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ (ä¾‹ï¼šApplicationã€AppProjectã€ãªã©)ã€€ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚ï¸â†ªï¸ï¼šGitHub - argoproj/argo-helm: ArgoProj Helm ChartsãŸã ã—Helmã®é‡è¦ãªä»•æ§˜ã¨ã—ã¦ã€ãƒãƒ£ãƒ¼ãƒˆã®æ›´æ–°æ™‚ã«ä½¿ç”¨ã™ã‚‹helm upgradeã‚³ãƒãƒ³ãƒ‰ã¯ã€CRDã‚’ä½œæˆã§ãã‚‹ä¸€æ–¹ã§ã“ã‚Œã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚Helmã§CRDã‚’ä½œæˆã™ã‚‹ã¨Helmã®ç®¡ç†ãƒ©ãƒ™ãƒ«ãŒæŒ¿å…¥ã•ã‚Œã¦ã—ã¾ã†ãŸã‚ã€ä½œæˆã®æ™‚ç‚¹ã‹ã‚‰CRDãŒHelmã®ç®¡ç†å¤–ã¨ãªã‚‹ã‚ˆã†ã«ã€kubectlã‚³ãƒãƒ³ãƒ‰ã§CRDã‚’ä½œæˆã—ãŸæ–¹ãŒã‚ˆã„ã§ã™ğŸ‘$ kubectl diff -k \"https://github.com/argoproj/argo-cd/manifests/crds?ref=\u003cãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°\u003e\"$ kubectl apply -k \"https://github.com/argoproj/argo-cd/manifests/crds?ref=\u003cãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°\u003e\"ArgoCDä¸Šã§Helmã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã¯ã“ã®ä»•æ§˜ã‚’æ°—ã«ã—ãªãã¦è‰¯ã„ã®ã‹ãªã€ã¨æ€ã£ãŸæ–¹ãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚ã§ã™ãŒæœ¬è¨˜äº‹ã§è§£èª¬ã—ãŸé€šã‚Šã€ArgoCDã¯cmp-serverã®helm templateã‚³ãƒãƒ³ãƒ‰ (ã“ã®æ™‚ã€--include-crdsã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹) ã‚„ã€application-controllerã®kubectl applyã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã‚‹ãŸã‚ã€CRDã‚‚ã¡ã‚ƒã‚“ã¨æ›´æ–°ã—ã¦ãã‚Œã¾ã™ğŸ‘ğŸ»ï¸â†ªï¸ï¼šHelm | Custom Resource Definitionsã€ï¼’ã€‘kube-controller-managerã¯ã€application-controllerã‚’æ“ä½œã—ã€Reconciliationã‚’å®Ÿæ–½ã—ã¾ã™ã€‚application-controllerã¯ã€Etcdä¸Šã«æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨åŒã˜çŠ¶æ…‹ã®ArgoCDç³»ã‚«ã‚¹ã‚¿ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ/å¤‰æ›´ã—ã¾ã™ã€‚How Operators work in Kubernetes | Red Hat Developerã€ï¼“ã€‘application-controllerã¯ã€repo-serverã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚å–å¾—ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ã€repo-serverã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã§ã‚ã‚‹cmp-serverãŒä½œæˆã—ãŸã‚‚ã®ã§ã™ã€‚ã€ï¼”ã€‘application-controllerã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã‚’ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚application-controllerã«ã¯ã€gitops-engineãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå†…è”µã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã¯ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ã¾ã§ã®åŸºæœ¬çš„ãªå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãªã‚Šã¾ã™ğŸ‘‡gitops-engine/â”œâ”€â”€ pkgâ”‚   â”œâ”€â”€ cacheâ”‚   â”œâ”€â”€ diff   # ãƒªãƒã‚¸ãƒˆãƒªã¨Clusterã®é–“ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å·®åˆ†ã‚’æ¤œå‡ºã™ã‚‹ã€‚ArgoCDã®Diffæ©Ÿèƒ½ã«ç›¸å½“ã™ã‚‹ã€‚â”‚   â”œâ”€â”€ engine # ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã„ã€GitOpsã®ä¸€é€£ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€‚â”‚   â”œâ”€â”€ health # Clusterã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚ArgoCDã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã«ç›¸å½“ã™ã‚‹ã€‚â”‚   â”œâ”€â”€ sync   # Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚ArgoCDã®Syncæ©Ÿèƒ½ã«ç›¸å½“ã™ã‚‹ã€‚â”‚   â””â”€â”€ utils  # ä»–ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«æ±ç”¨çš„ãªé–¢æ•°ã‚’æä¾›ã™ã‚‹ã€‚â”‚...â†ªï¸ï¼šgitops-engine/design-top-down.md at master Â· argoproj/gitops-engine Â· GitHubã€ï¼•ã€‘application-controllerã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨ã€repo-serverã‹ã‚‰å–å¾—ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å·®åˆ†ã‚’æ¤œå‡ºã—ã¾ã™ã€‚ã“ã“ã§ã€kubectl diffã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡ŒãŒè‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚ã€ï¼–ã€‘application-controllerã¯ã€å‡¦ç†çµæœã‚’redis-serverã«ä¿ç®¡ã—ã¾ã™ã€‚redis-serverã¯ã€Applicationã‚„ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒŸãƒƒãƒˆã®å˜ä½ã§ã€application-controllerã®å‡¦ç†çµæœã‚’ä¿ç®¡ã—ã¦ã„ã¾ã™ã€‚$ kubectl exec -it argocd-redis-server \\    -n foo \\    -- sh -c \"redis-cli --raw\"127.0.0.1:6379\u003e keys *...app|resources-tree|\u003cApplicationå\u003e|\u003cã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³\u003ecluster|info|\u003cãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã®URL\u003e|\u003cã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³\u003egit-refs|\u003cãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ/ãƒãƒ£ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®URL\u003e|\u003cã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³\u003emfst|app.kubernetes.io/instance|\u003cApplicationå\u003e|\u003cæœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥å€¤\u003e|\u003cãƒ‡ãƒ—ãƒ­ã‚¤å…ˆNamespace\u003e|*****|\u003cã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³\u003e...ã€ï¼—ã€‘application-controllerã¯ã€Applicationã®æ“ä½œã«å¿œã˜ã¦ã€Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã“ã“ã§ã€kubectl applyã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡ŒãŒè‡ªå‹•åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«ã¯ã€metadata.managedFieldsã‚­ãƒ¼ãŒã‚ã‚Šã€ä½•ãŒãã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆ/å¤‰æ›´ã—ãŸã®ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚å®Ÿéš›ã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€ç¢ºã‹ã«application-controllerãŒãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ä½œæˆ/å¤‰æ›´ã—ã¦ãã‚ŒãŸã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚apiVersion: apps/v1kind: Deploymentmetadata:  managedFields:    # ArgoCDã®application-controllerã«ã‚ˆã‚‹ç®¡ç†    - manager: argocd-application-controller      apiVersion: apps/v1      # kube-apiserverã«å¯¾ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹      operation: Update      time: \"2022-01-01T16:00:00.000Z\"      # ArgoCDã®application-controllerãŒç®¡ç†ã™ã‚‹ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ã‚­ãƒ¼éƒ¨åˆ†      fields: ...ï¸â†ªï¸ï¼šServer-Side Apply | Kubernetes05. dex-serverdex-serverã¨ã¯ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ã‚‹dex-serverã§ã™ã€‚SSO (ä¾‹ï¼šOAuth 2.0ã€SAMLã€OIDC) ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã«ã€argocd-serverã®ä»£ã‚ã‚Šã«èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ (ä¾‹ï¼šGitHubã€Keycloakã€AWS Cognitoã€Google Authã€ãªã©) ã«ã“ã‚Œã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€argocd-serverä¸Šã®èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å§”è­²ã§ãã¾ã™ã€‚â†ªï¸ï¼šGitHub - dexidp/dex: OpenID Connect (OIDC) identity and OAuth 2.0 provider with pluggable connectorsdex-serverã‚’ä½¿ã‚ãšã«ã€argocd-serverã‹ã‚‰IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç›´æ¥çš„ã«é€ä¿¡ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚åŸ·ç­†æ™‚ç‚¹ (2023/05/02) ã§ã€argocd-serverã¯ç‰¹ã«OIDCã®èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã§ãã‚‹ãŸã‚ã€ãƒ­ã‚°ã‚¤ãƒ³è¦ä»¶ãŒOIDCã®å ´åˆã¯ã€dex-serverã‚’å¿…ãšã—ã‚‚æ¡ç”¨ã—ã¦ãªãã‚‚ã‚ˆã„ã§ã™ã€‚è¨€ã„æ›ãˆã‚Œã°ã€ãã®ä»–ã®SSO (ä¾‹ï¼šOAuth 2.0ã€SAML) ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€dex-serverã‚’æ¡ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ğŸ‘ï¸â†ªï¸ï¼šOverview - Argo CD - Declarative GitOps CD for Kubernetesä»•çµ„ã¿ã€ï¼‘ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ãŒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (argocd-server) ã«SSOã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã€ï¼’ã€‘argocd-serverã¯ã€èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å§”è­²ã™ã‚‹ãŸã‚ã«ã€dex-serverã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚argo-cd/authz-authn.md at master Â· argoproj/argo-cd Â· GitHubã€ï¼“ã€‘dex-serverã¯ã€èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªæƒ…å ±ã¯ã€ConfigMap (argocd-cm) ã§è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚argocd-cmã®ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’GitHubã¨ã—ã€èªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚apiVersion: v1kind: ConfigMapmetadata:  namespace: foo  name: argocd-cmdata:  dex.config: |    connectors:      - type: github        id: github        name: GitHub SSO        config:          clientID: *****          clientSecret: *****        # dex-serverãŒèªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã™ã‚‹URLã‚’è¨­å®šã™ã‚‹        redirectURI: https://example.com/api/dex/callbackdex.configã‚­ãƒ¼é…ä¸‹ã®è¨­å®šæ–¹æ³•ã«é–¢ã—ã¦ã¯ã€dexã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã¿ã‚‹ã¨è‰¯ã„ã§ã™ğŸ‘â†ªï¸ï¼šDexã€ï¼”ã€‘dex-serverã¯ã€å‰ã®æ‰‹é †ã§ä½œæˆã—ãŸèªå¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«é€ä¿¡ã—ã¾ã™ã€‚ã€ï¼•ã€‘IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å´ã§SSOã®èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿæ–½ã—ã¾ã™ã€‚IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ã€ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯URL (\u003cArgoCDã®ãƒ‰ãƒ¡ã‚¤ãƒ³å\u003e/api/dex/callback) ã‚’æŒ‡å®šã—ã¦ã€èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é€ä¿¡ã—ã¾ã™ã€‚èªå¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ã€argocd-serverã‚’ä»‹ã—ã¦ã€dex-serverã«å±Šãã¾ã™ã€‚GitHubã‚’IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã™ã‚‹å ´åˆã€ Developer settingsã‚¿ãƒ– ã§SSOã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã®æ™‚ã«Authorization callback URLã¨ã„ã†è¨­å®šç®‡æ‰€ãŒã‚ã‚‹ã¯ãšã§ã™ğŸ‘ğŸ»ã€ï¼–ã€‘argocd-serverã¯ã€AuthZã§èªå¯ãƒ•ã‚§ãƒ¼ã‚ºã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ConfigMap (argocd-rbac-cm) ã‚’å‚ç…§ã—ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚°ãƒ«ãƒ¼ãƒ—ã«ã€ArgoCDç³»ãƒªã‚½ãƒ¼ã‚¹ã«é–¢ã™ã‚‹èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸ã—ã¾ã™ã€‚ã–ã£ãã‚Šã—ãŸå®Ÿè£…ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã“ã“ã§ã¯ã€developerãƒ­ãƒ¼ãƒ«ã«ã¯devã¨ã„ã†AppProjectã«å±ã™ã‚‹ArgoCDç³»ãƒªã‚½ãƒ¼ã‚¹ã«ã®ã¿ã€ã¾ãŸmaintainerãƒ­ãƒ¼ãƒ«ã«ã¯å…¨ã¦ã®AppProjectã®æ“ä½œã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã“ã‚Œã‚‰ã®ãƒ­ãƒ¼ãƒ«ã‚’ã€IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§èªè¨¼ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã¦ã„ã¾ã™ã€‚ç‰¹å®šã®ArgoCDç³»ãƒªã‚½ãƒ¼ã‚¹ã®ã¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚Œã°ã€çµæœã¨ã—ã¦ç‰¹å®šã®Clusterã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã¿ã‚’è¨±å¯ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ğŸ‘apiVersion: v1kind: ConfigMapmetadata:  name: argocd-rbac-cm  namespace: foodata:  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ãƒ«  policy.default: role:developer  policy.csv: |    # ãƒ­ãƒ¼ãƒ«ã¨èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©ã™ã‚‹ã€‚    p, role:developer, *, *, dev/*, allow    p, role:maintainer, *, *, *, allow    # IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§èªè¨¼ã•ã‚ŒãŸã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ­ãƒ¼ãƒ«ã‚’ç´ä»˜ã‘ã‚‹ã€‚    g, developers, role:developer    g, maintainers, role:maintainer  scopes: \"[groups]\"ConfigMap (argocd-rbac-cm) ã®èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã®å®šç¾©ã«ã¯ã€ Casbin ã®è¨˜æ³•ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»Šå›ã®å®Ÿè£…ä¾‹ã§ä½¿ç”¨ã—ãŸpã¨gã§ã¯ã€ä»¥ä¸‹ã‚’å®šç¾©ã§ãã¾ã™ã€‚    è¨˜å·        èª¬æ˜        è¨˜æ³•    p (ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³)         ãƒ­ãƒ¼ãƒ«ã¨èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å®šç¾©ã™ã‚‹ã€‚        p, \u003cãƒ­ãƒ¼ãƒ«å\u003e \u003cKubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡\u003e \u003cã‚¢ã‚¯ã‚·ãƒ§ãƒ³å\u003e \u003cAppProjectå\u003e/\u003cKubernetesãƒªã‚½ãƒ¼ã‚¹ã®è­˜åˆ¥å\u003e    g (ã‚°ãƒ«ãƒ¼ãƒ—)         ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ­ãƒ¼ãƒ«ã‚’ç´ä»˜ã‘ã‚‹ã€‚        g, \u003cã‚°ãƒ«ãƒ¼ãƒ—å\u003e \u003cãƒ­ãƒ¼ãƒ«å\u003e    RBAC Configuration - Argo CD - Declarative GitOps CD for Kubernetes06. argocd-server (argocd-apiserver)argocd-serverã¨ã¯æœ€å¾Œã«ã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚ã‚‹argocd-serverã§ã™ã€‚ã€argocd-apiserverã€ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚ã¿ã‚“ãªãŒã‚ˆãçŸ¥ã‚‹ArgoCDã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã™ã€‚ã¾ãŸã€ArgoCDã®APIã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã€ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨é€šä¿¡ã—ã¾ã™ğŸ¦„ä»•çµ„ã¿ã€ï¼‘ã€‘application-controllerã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã‚’ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚ã€ï¼’ã€‘application-controllerã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨ã€ãƒãƒ¼ãƒªãƒ³ã‚°å¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å·®åˆ†ã‚’æ¤œå‡ºã—ã¾ã™ã€‚ã€ï¼“ã€‘application-controllerã¯ã€å‡¦ç†çµæœã‚’redis-serverã«ä¿ç®¡ã—ã¾ã™ã€‚ã€ï¼”ã€‘argocd-serverã¯ã€redis-serverã‹ã‚‰å‡¦ç†çµæœã‚’å–å¾—ã—ã¾ã™ã€‚ã€ï¼•ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ãŒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (argocd-server) ã«SSOã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã€ï¼–ã€‘Ingressã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯ã€Ingressã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã‚’å‚ç…§ã—ã€argocd-serverã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚ã€ï¼—ã€‘argocd-serverã¯ã€ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«èªå¯ãƒ•ã‚§ãƒ¼ã‚ºã‚’å§”è­²ã™ã‚‹ãŸã‚ã«ã€dex-serverã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚ã€ï¼˜ã€‘IDãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä¸Šã§èªè¨¼ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã¾ã™ã€‚argocd-serverã¯ã€ConfigMap (argocd-rbac-cm) ã‚’å‚ç…§ã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ã«èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»˜ä¸ã—ã¾ã™ã€‚ã€ï¼™ã€‘argocd-serverã¯ã€èªå¯ã‚¹ã‚³ãƒ¼ãƒ—ã«å¿œã˜ã¦ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ãŒApplicationã‚’æ“ä½œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚apiVersion: v1kind: ConfigMapmetadata:  name: argocd-cmd-params-cm  namespace: foodata:  # è¨­å®šã—ã¦ã¯ãƒ€ãƒ¡  # application.namespaces: \"*\" # å…¨ã¦ã®Namespaceã‚’è¨±å¯ã™ã‚‹ã€‚apiVersion: argoproj.io/v1alpha1kind: AppProjectmetadata:  name: dev-foo-project  namespace: foospec:  # è¨­å®šã—ã¦ã¯ãƒ€ãƒ¡  # sourceNamespaces:  #  - \"foo\"ã“ã‚Œã‚‰ã«ã‚ˆã‚Šã€`foo`ã«å±ã™ã‚‹ArgoCDã¯ã€ä»–ã®Namespaceã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ğŸ‘â†ªï¸ï¼šInstallation - Argo CD - Declarative GitOps CD for Kubernetesã€ï¼‘ï¼ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆClusterç®¡ç†è€…ã¯ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (argocd-server) ã‚’ä½¿ç”¨ã—ã¦ã€Clusterã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’Syncã—ã¾ã™ã€‚ã“ã®æ™‚ã€Applicationã‚’ä»‹ã—ã¦application-controllerã‚’æ“ä½œã—ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚å›³ã§ã¯ã€App-Of-Appsãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ãŸã¨ä»®å®šã—ã¦ã„ã¾ã™ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã€Applicationã‚’éšå±¤ä¸Šã«ä½œæˆã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€æœ€ä¸‹å±¤ã®Applicationé…ä¸‹ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ã‚ˆã‚Šç–çµåˆã«ç®¡ç†ã§ãã¾ã™âœŒï¸ä¾‹ãˆã°ä»¥ä¸‹ã®ç”»åƒã®é€šã‚Šã€æœ€ä¸Šä½ã®Applicationé…ä¸‹ã«ã€ãƒãƒ¼ãƒ åˆ¥ã®è¦ªApplicationã‚’é…ç½®ã—ã¾ã™ (ã‚¢ãƒ—ãƒªãƒãƒ¼ãƒ ã®è¦ªApplicationã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ã®ãã‚Œ) ã€‚ãã®å¾Œã€ä¸¡æ–¹ã®Applicationé…ä¸‹ã«ã•ã‚‰ã«ãƒãƒ£ãƒ¼ãƒˆåˆ¥ã«æœ€ä¸‹å±¤ã®å­Applicationã‚’é…ç½®ã—ã€ãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªãƒãƒ¼ãƒ æœ€ä¸‹å±¤ã®å­Applicationã§ã¯ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ£ãƒ¼ãƒˆã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ã®å­Applicationã§ã¯ç›£è¦–/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ç³»ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç®¡ç†ã—ã¾ã™ğŸ‘07. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã¾ã¨ã‚ä»Šã¾ã§ã®å…¨ã¦ã®æƒ…å ±ã‚’ã–ã£ãã‚Šæ•´ç†ã—ã¦ç°¡ç•¥åŒ–ã™ã‚‹ã¨ã€ArgoCDã¯ä»¥ä¸‹ã®ä»•çµ„ã¿ã§ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ğŸ‘‡08. ãŠã‚ã‚Šã«ArgoCDã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚ArgoCDã¯ã€UIãŒä½¿ã„ã‚„ã™ãã€ä»•çµ„ã¿ã®è©³ç´°ã‚’çŸ¥ã‚‰ãšã¨ã‚‚æ¯”è¼ƒçš„ç°¡å˜ã«é‹ç”¨ã§ãã‚‹ãŸã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ„ãƒ¼ãƒ«ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã‚‚ã—ArgoCDã‚’ä½¿ã‚ãšã«ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã‚‹æ–¹ã¯ã€ArgoCDã®æ¡ç”¨ã‚’ãƒã‚¤ãƒ‘ãƒ¼ãƒ»ã‚¦ãƒ«ãƒˆãƒ©ãƒ»ã‚¢ãƒ«ãƒ†ã‚£ãƒ¡ãƒƒãƒˆãŠã™ã™ã‚ã—ã¾ã™ğŸ‘ãªãŠã€ç™»å ´ã—ãŸè¨­è¨ˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ã„ãã¤ã‹ã¯ã€ä»¥ä¸‹ã®æ›¸ç±ã«ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã®ã§ã€ãœã²ã”ä¸€èª­ã„ãŸã ã‘ã‚‹ã¨ğŸ™‡ğŸ»â€â†ªï¸ï¼šAmazon.co.jp: GitOps Cookbook (English Edition) é›»å­æ›¸ç±: Vinto, Natale, Bueno, Alex Soto: æ´‹æ›¸Amazon | Argo CD in Practice: The GitOps way of managing cloud-native applications | Costea, Liviu, Economakis, Spiros, Matyushentsev, Alexander | Design Tools \u0026 Techniquesè¬è¾ArgoCDã®è¨­è¨ˆã«ã‚ãŸã‚Šã€@yaml_villager ã•ã‚“ã«æœ‰ç›Šãªãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ã”æ•™æˆã„ãŸã ãã¾ã—ãŸã€‚ã“ã®å ´ã§æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ğŸ™‡ğŸ»â€","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2023/05/02/145115","isoDate":"2023-05-02T05:42:57.000Z","dateMiliSeconds":1683006177000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"},{"title":"ã€Istioâ›µï¸ã€‘Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿","contentSnippet":"01. ã¯ã˜ã‚ã«02. Istioã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã‚’èª¬æ˜ã™ã‚‹å‰ã«ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã¨ã¯ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã®æ‰‹é †ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã€ã®å‘¼ç§°ã®ç”±æ¥03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ã“ã“ã§èª¬æ˜ã™ã‚‹ã“ã¨ã€ï¼‘ã€‘ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®æ¤œè¨¼ã€ï¼’ã€‘æ–°Istiodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ï¼“ã€‘Webhookã®å®›å…ˆã®Serviceã®å¤‰æ›´ã€ï¼”ã€‘IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ï¼•ã€‘ä¸€éƒ¨ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ï¼–ã€‘ãƒ¦ãƒ¼ã‚¶ã®æ‰‹ã‚’å€Ÿã‚ŠãŸãƒ†ã‚¹ãƒˆã€ï¼—ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®æ®µéšçš„ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ï¼˜ã€‘æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«04. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®è©³ç´°ã“ã“ã§èª¬æ˜ã™ã‚‹ã“ã¨å‰æNamespaceIstiodIngressGatewayãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã€ï¼‘ã€‘ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®æ¤œè¨¼ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨istioctl x precheckã‚³ãƒãƒ³ãƒ‰kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentâ–¼ Webhookã®å®›å…ˆã®Serviceâ–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfigurationã€ï¼’ã€‘æ–°Istiodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨istioctl versionã‚³ãƒãƒ³ãƒ‰istioctl installã‚³ãƒãƒ³ãƒ‰kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentâ–¼ Webhookã®å®›å…ˆã®Serviceâ–¼ Webhookã®å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfigurationã€ï¼“ã€‘Webhookã®å®›å…ˆã®Serviceã®å¤‰æ›´ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨istioctl tag setã‚³ãƒãƒ³ãƒ‰ã€ï¼”ã€‘IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã€ï¼•ã€‘ä¸€éƒ¨ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã€ï¼–ã€‘ãƒ¦ãƒ¼ã‚¶ã®æ‰‹ã‚’å€Ÿã‚ŠãŸãƒ†ã‚¹ãƒˆã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚‚ã—å•é¡ŒãŒèµ·ã“ã£ãŸå ´åˆã€ï¼—ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®æ®µéšçš„ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã€ï¼˜ã€‘æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨istioctl uninstallã‚³ãƒãƒ³ãƒ‰kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentâ–¼ Webhookã®å®›å…ˆã®Serviceâ–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfiguration05. ãŠã‚ã‚Šã«01. ã¯ã˜ã‚ã«éš ã—ã¾ã›ã‚“ã€‚æœ‰å‰å¼˜è¡Œã®ã‚µãƒ³ãƒ‡ãƒ¼ãƒŠã‚¤ãƒˆãƒ‰ãƒªãƒ¼ãƒãƒ¼ãŒç”ŸããŒã„ã§ã™ã€‚ã•ã¦ã€æœ€è¿‘ã®æ¥­å‹™ã§Istioã‚’ã²ãŸã™ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚æ¡ç”¨ã—ãŸã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ç´¹ä»‹ã‚‚å…¼ã­ã¦ã€Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿ã‚’è¨˜äº‹ã§è§£èª¬ã—ã¾ã—ãŸğŸš€åŸ·ç­†æ™‚ç‚¹ (2023/02/26) ã§ã¯ã€Istioã®Istiodã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ (ä»¥é™ã€Istiodã¨ã—ã¾ã™) ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã«ã¯ã€ã€ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹æ–¹å¼ã€ã¨ã€ã‚«ãƒŠãƒªã‚¢æ–¹å¼ã€ãŒã‚ã‚Šã¾ã™ã€‚ã¾ãŸåˆã‚ã›ã¦ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¿…è¦ãªIstioã®IngressGatewayã«ã‚‚ã€ãã®æ‰‹æ³•ã«ã€ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹æ–¹å¼ã€ã¨ã€ã‚«ãƒŠãƒªã‚¢æ–¹å¼ã€ãŒã‚ã‚Šã¾ã™ã€‚ä»Šå›ã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã¨ã—ã¦ã€Istiodã§ã¯ã€ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ã€IngressGatewayã§ã¯ã€ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ãã‚Œã§ã¯ã€Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—â†ªï¸ï¼šIstio / Canary UpgradesIstio / Installing Gateways02. Istioã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã‚’èª¬æ˜ã™ã‚‹å‰ã«ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã¨ã¯Istiodã®ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒç†è§£ã—ã‚„ã™ããªã‚‹ã‚ˆã†ã«ã€ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰èª¬æ˜ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã¯ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ†ã‚¹ãƒˆã—ã¦ã‚‚ã‚‰ã„ãªãŒã‚‰ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ã‚‚ã—ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€ 03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ ã¾ã§é£›ã°ã—ã¦ãã ã•ã„ğŸ™‡ğŸ»â€ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã®æ‰‹é †ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã¯ã€ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’çŠ ç‰²ã«ã™ã‚‹ã“ã¨ã«ãªã‚‹ä¸€æ–¹ã§ã€ã‚¢ãƒ—ãƒªã‚’å®Ÿåœ°çš„ã«ãƒ†ã‚¹ãƒˆã§ãã‚‹ç‚¹ã§å„ªã‚Œã¦ã„ã¾ã™ã€‚æ‰‹é †ã‚’äº¤ãˆãªãŒã‚‰èª¬æ˜ã—ã¾ã™ã€‚â†ªï¸ï¼šCanaryReleaseã€ï¼‘ã€‘æ—§ç’°å¢ƒã®ã‚¢ãƒ—ãƒªã‚’æ®‹ã—ãŸã¾ã¾ã€æ–°ç’°å¢ƒã‚’ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™ã€‚ã“ã®æ®µéšã§ã¯ã€å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ (100%) ã‚’æ—§ç’°å¢ƒã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚ã€ï¼’ã€‘ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã§é‡ã¿ä»˜ã‘ã‚’å¤‰æ›´ã—ã€ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ã“ã“ã§ã¯10%) ã‚’æ–°ç’°å¢ƒã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚ã€ï¼“ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹ã‚’å€Ÿã‚Šã¦æ–°ç’°å¢ƒã‚’å®Ÿåœ°çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™ (ä¾‹ï¼šè©²å½“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒåŸºæº–å€¤ã‚’æº€ãŸã™ã‹) ã€‚ã€ï¼”ã€‘æ–°ç’°å¢ƒã«å•é¡ŒãŒèµ·ã“ã‚‰ãªã‘ã‚Œã°ã€é‡ã¿ä»˜ã‘ã‚’æ®µéšçš„ã«å¤‰æ›´ã—ã€æœ€çµ‚çš„ã«ã¯å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ (100%) ã‚’æ–°ç’°å¢ƒã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚ã€ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã€ã®å‘¼ç§°ã®ç”±æ¥ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã«ã¤ã„ã¦ã¯ã€ãã®å‘¼ç§°ã®ç”±æ¥ã‚’çŸ¥ã‚‹ã¨ã€ã‚ˆã‚Šç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã¯ã€20ä¸–ç´€é ƒã®ç‚­å‘åŠ´åƒè€…ã®å±æ©Ÿå¯ŸçŸ¥æ–¹æ³•ã«ç”±æ¥ã—ã¾ã™ã€‚ç‚­é‰±å†…ã«ã¯æœ‰æ¯’ãªä¸€é…¸åŒ–ç‚­ç´ ãŒç™ºç”Ÿã™ã‚‹å ´æ‰€ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ç„¡è‰²ç„¡è‡­ãªã®ã§ã€æ°—ã¥ãã“ã¨ã«é…ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãã“ã§å½“æ™‚ã®ç‚­é‰±åŠ´åƒè€…ã¯ã€ä¸€é…¸åŒ–ç‚­ç´ ã«æ•æ„Ÿãªã€ã‚«ãƒŠãƒªã‚¢ã€ã‚’ç‚­é‰±å†…ã«æŒã¡è¾¼ã¿ã€ã‚«ãƒŠãƒªã‚¢ã®æ§˜å­ã‹ã‚‰ä¸€é…¸åŒ–ç‚­ç´ ã®å­˜åœ¨ã‚’å¯ŸçŸ¥ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ãŸãã†ã§ã™ã€‚ã¤ã¾ã‚Šã€å…ˆã»ã©ã®ã€çŠ ç‰²ã«ãªã‚‹ä¸€éƒ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãŒã€ã“ã“ã§ã„ã†ã‚«ãƒŠãƒªã‚¢ã¨ã„ã†ã‚ã‘ã§ã™ğŸ˜¨ç”»åƒå¼•ç”¨å…ƒï¼šGeorge McCaa, U.S. Bureau of Minesâ†ªï¸ï¼šAbout canary deployment in simple wordsThis Device Was Used to Resuscitate Canaries in Coal Mines After They Signaled Danger03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ã“ã“ã§èª¬æ˜ã™ã‚‹ã“ã¨ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã«ã¤ã„ã¦ç†è§£ã—ãŸã¨ã“ã‚ã§ã€Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ã‚’èª¬æ˜ã—ã¾ã™ã€‚ãŠãŠã‚ˆãä»¥ä¸‹ã®æ‰‹é †ã‹ã‚‰ãªã‚Šã¾ã™ã€‚ãªãŠå„ç•ªå·ã¯ã€04. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®è©³ç´° ã®ã€ï¼‘ã€‘ã€œã€ï¼˜ã€‘ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã€ï¼‘ã€‘ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®æ¤œè¨¼æ—§IstiodãŒç¨¼åƒã—ã¦ã„ã¾ã™ã€‚ã“ã“ã§ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå¯èƒ½ã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã—ã¦ãŠãã¾ã™ã€‚ã€ï¼’ã€‘æ–°Istiodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–°Istiod (discoveryã‚³ãƒ³ãƒ†ãƒŠ) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã€ï¼“ã€‘Webhookã®å®›å…ˆã®Serviceã®å¤‰æ›´æ–°Istiodã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã€Webhookã®å®›å…ˆã®Serviceã‚’å¤‰æ›´ã—ã¾ã™ã€‚ã“ã®æ‰‹é †ã¯é‡è¦ã§ã€å¾Œã® ã€ï¼“ã€‘Webhookã®å®›å…ˆã®Serviceã®å¤‰æ›´ ã§è©³ç´°ã‚’èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚ã€ï¼”ã€‘IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã€ï¼•ã€‘ä¸€éƒ¨ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ä¸€éƒ¨ã®Namespaceã§ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã®ã‚ˆã†ãªé‡ã¿ä»˜ã‘ãŒãªãã€ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ã€ã‚«ãƒŠãƒªã‚¢ã€ã¨ã„ã†å‘¼ç§°ã«é•å’Œæ„Ÿã‚’æŒã¤æ–¹ãŒã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã“ã‚Œã«ã¤ã„ã¦ã¯ã€å…¨ã¦ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ–‰ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ã®ã§ã¯ãªãã€æ®µéšçš„ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãæ§˜å­ã‚’ã€ã‚«ãƒŠãƒªã‚¢ã€ã¨å‘¼ç§°ã—ã¦ã„ã‚‹ã€ã¨å€‹äººçš„ã«æ¨æ¸¬ã—ã¦ã„ã¾ã™ã€‚ã‚‚ã—ã€ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ã®ç”±æ¥ã‚’ã”å­˜ã˜ã®æ–¹ã¯ã€ãœã²æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨ğŸ™‡ğŸ»â€ã€ï¼–ã€‘ãƒ¦ãƒ¼ã‚¶ã®æ‰‹ã‚’å€Ÿã‚ŠãŸãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹ã‚’å€Ÿã‚Šã¦ã€å®Ÿåœ°çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™ (ä¾‹ï¼šè©²å½“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒåŸºæº–å€¤ä»¥ä¸‹ã‚’æº€ãŸã™ã‹) ã€‚ã€ï¼—ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®æ®µéšçš„ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ–°Istiodã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã«å•é¡ŒãŒèµ·ã“ã‚‰ãªã‘ã‚Œã°ã€ä»–ã®Namespaceã§ã‚‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’æ®µéšçš„ã«ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚ä¸€æ–¹ã§ã‚‚ã—å•é¡ŒãŒèµ·ã“ã‚Œã°ã€Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¨IngressGatewayã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã€ï¼˜ã€‘æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æœ€å¾Œã«ã€æ—§Istiodã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚â†ªï¸ï¼šIstio / Canary Upgrades04. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®è©³ç´°ã“ã“ã§èª¬æ˜ã™ã‚‹ã“ã¨ã“ã“ã‹ã‚‰ã¯ã€03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ ã‚’æ·±ã¼ã£ã¦ã„ãã¾ã™ã€‚ãƒ¤ã‚µã‚¤ãƒ‹ãƒ³ãƒ‹ã‚¯ã‚¢ãƒ–ãƒ©ãƒã‚·ãƒã‚·ãªèª¬æ˜ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§ã€ã“ã“ã¾ã§ã‚’é£Ÿã¹åˆ‡ã‚ŒãŸæ–¹ã®ã¿é€²ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ğŸ¥ºä»Šå›ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ä¸€ç•ªå„ªå…ˆã—ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹istioctlã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ãŸæ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚ãªãŠå„ç•ªå·ã¯ã€03. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ ã®ã€ï¼‘ã€‘ã€œã€ï¼˜ã€‘ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚istioctlã‚³ãƒãƒ³ãƒ‰ä»¥å¤–ã®ãƒ„ãƒ¼ãƒ« (ä¾‹ï¼šhelmã‚³ãƒãƒ³ãƒ‰ã€helmfileã‚³ãƒãƒ³ãƒ‰ã€ArgoCD) ã‚’ä½¿ç”¨ã—ã¦ã‚‚ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚ç´°ã‹ãªæ‰‹é †ãŒç•°ãªã‚‹ã ã‘ã§ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®æ¦‚è¦ã«é–¢ã—ã¦ã¯åŒã˜ã§ã™ğŸ™†ğŸ»â€å‰æNamespaceã¾ãšæœ€åˆã«ã€å‰æã¨ãªã‚‹çŠ¶æ³ã‚’è¨­å®šã—ã¦ãŠãã¾ã™ã€‚å„Namespaceã®istio.io/revãƒ©ãƒ™ãƒ«ã«defaultãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚$ kubectl get namespace -L istio.io/revNAME              STATUS   AGE   REVfoo               Active   34d   defaultbar               Active   34d   defaultbaz               Active   34d   defaultistio-ingress     Active   34d   default...ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã©ã‚“ãªå€¤ã§ã‚‚å•é¡Œãªãã€ã‚ˆãã‚ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦defaultã‚„stableãªã©ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«æ›¸ãèµ·ã“ã™ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚apiVersion: v1kind: Namespacemetadata:  name: foo  labels:    istio.io/rev: defaultã“ã®istio.io/revãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãã®Namespaceã®Podã«istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰è¨˜äº‹ã§èª¬æ˜ã—ã¦ã¾ã™ã€‚ã‚‚ã—æ°—ã«ãªã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚‚ã‚ˆã‚ã—ãã©ã†ãğŸ™‡ğŸ»â€Istiodã™ã§ã«1-14-6ã®IstiodãŒå‹•ã„ã¦ãŠã‚Šã€1-15-4ã«ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚Istiodã¯Deploymenté…ä¸‹ã®Podã§ã‚ã‚Šã€ã“ã®Podã¯Istiodã®å®Ÿä½“ã§ã‚ã‚‹discoveryã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚$ kubectl get deployment -n istio-system -l app=istiodNAME                   READY   UP-TO-DATE   AVAILABLE   AGEistiod-1-14-6          1/1     1            1           47s # 1-14-6IngressGatewayIngressGatewayã¯Istiodã¨ã¯ç•°ãªã‚‹Namespaceã§å‹•ã„ã¦ãŠã‚Šã€ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚IngressGatewayã¯istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚$ kubectl get deployment -n istio-ingressNAME                   READY   UP-TO-DATE   AVAILABLE   AGEistio-ingressgateway   1/1     1            1           47sã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã¯ã€Istiodã¨IngressGatewayã¯ç•°ãªã‚‹Namespaceã§å‹•ã‹ã™ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚â†ªï¸ï¼šIstio / Installing Gatewaysãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å„Namespaceã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå‹•ã„ã¦ã„ã¾ã™ã€‚ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®Podã¯istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚$ kubectl get deployment -n fooNAME   READY   UP-TO-DATE   AVAILABLE   AGEfoo    2/2     1            1           47s...$ kubectl get deployment -n barNAME   READY   UP-TO-DATE   AVAILABLE   AGEbar    2/2     1            1           47s..$ kubectl get deployment -n bazNAME   READY   UP-TO-DATE   AVAILABLE   AGEbaz    2/2     1            1           47s...ã€ï¼‘ã€‘ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã®æ¤œè¨¼ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å‰ã«ã€ç¾åœ¨ã®Kubernetes ClusterãŒã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚â†ªï¸ï¼šBefore you upgradeistioctl x precheckã‚³ãƒãƒ³ãƒ‰istioctl x precheckã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¦ä»¶ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚å•é¡ŒãŒãªã‘ã‚Œã°ã€istioctlã‚³ãƒãƒ³ãƒ‰ã¯No issue ...ã®æ–‡è¨€ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚$ istioctl x precheckâœ… No issues found when checking the cluster.Istiois safe to install or upgrade!  To get started, check out https://istio.io/latest/docs/setup/getting-started/ã‚‚ã—ã€å•é¡ŒãŒã‚ã‚‹å ´åˆã€istioctlã‚³ãƒãƒ³ãƒ‰ã¯ã‚¨ãƒ©ãƒ¼æ–‡è¨€ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ä¾‹ãˆã°ã€Istioã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯kube-apiserverã¨é€šä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€kube-apiserverã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã™ãã‚‹ã›ã„ã§IstioãŒéå¯¾å¿œã§ã‚ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ğŸ˜­kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentkubectl getã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ç¾åœ¨ã®Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€1-14-6ã®DeploymentãŒã‚ã‚Šã¾ã™ã€‚$ kubectl get deployment -n istio-system -l app=istiodNAME                   READY   UP-TO-DATE   AVAILABLE   AGEistiod-1-14-6          1/1     1            1           47s # 1-14-6istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡â–¼ Webhookã®å®›å…ˆã®Serviceæ¬¡ã«ã€ Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€1-14-6ã®ServiceãŒã‚ã‚Šã¾ã™ã€‚$ kubectl get service -n istio-system -l app=istiodNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGEistiod-1-14-6   ClusterIP   10.96.93.151     \u003cnone\u003e        15010/TCP,15012/TCP,443/TCP,15014/TCP   109s # 1-14-6ã“ã®Serviceã¯ã€kube-apiserverã‹ã‚‰Istiodã¸ã®Webhookã‚’ä»²ä»‹ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡â–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfigurationæœ€å¾Œã«ã€MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€istio-revision-tag-\u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003eã¨istio-sidecar-injector-\u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003eã®MutatingWebhookConfigurationãŒã‚ã‚Šã¾ã™ã€‚$ kubectl get mutatingwebhookconfigurationsNAME                            WEBHOOKS   AGEistio-revision-tag-default      2          114s  # ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨istio-sidecar-injector-1-14-6   2          2m16s # ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ç”¨ã®ãŸã‚ä»Šå›ã¯è¨€åŠã—ãªã„istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã§ã„ã†ã¨ã€ä»¥ä¸‹ã®èµ¤æ ã®è¦ç´ ã§ã™ğŸ‘‡ã“ã‚Œã‚‰ã®ã†ã¡ã€å‰è€… (istio-revision-tag-\u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003e) ã‚’ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®MutatingWebhookConfigurationã¯ã€Webhookã®å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹ãŸã‚ã€çµæœçš„ã«istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ±ºã‚ã¾ã™ã€‚ã“ã“ã§ã€MutatingWebhookConfigurationã®istio.io/revãƒ©ãƒ™ãƒ«ã¨istio.io/tagãƒ©ãƒ™ãƒ«ã®å€¤ã‚‚ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \\    | yq '.metadata.labels'...istio.io/rev: 1-14-6istio.io/tag: default...istio.io/revãƒ©ãƒ™ãƒ«ã¯Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€istio.io/tagãƒ©ãƒ™ãƒ«ã¯ã“ã‚Œã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€.webhooks[].namespaceSelectorã‚­ãƒ¼é…ä¸‹ã®istio.io/revã‚­ãƒ¼ã®æ¤œçŸ¥ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \\    | yq '.webhooks[]'...namespaceSelector:  matchExpressions:    - key: istio.io/rev      operator: In      values:        - default...åˆã‚ã›ã¦ã€.webhooks[].clientConfig.serviceã‚­ãƒ¼é…ä¸‹ã®Serviceã‚’åå‰ã‚’ç¢ºèªã—ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \\    | yq '.webhooks[].clientConfig'...service:  name: istiod-1-14-6...ã“ã“ã§ã€é‡è¦ãªä»•çµ„ã¿ã‚’ãŠã•ã‚‰ã„ã—ã¾ã™ã€‚Namespaceã§istio.io/revãƒ©ãƒ™ãƒ«ã«defaultã‚’è¨­å®šã—ã¦ã‚ã‚‹ã¨ã—ã¾ã™ã€‚ã™ã‚‹ã¨ã€ä¸Šè¨˜ã®MutatingWebhookConfigurationãŒã“ã‚Œã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚MutatingWebhookConfigurationã«ã¯defaultã«å¯¾å¿œã™ã‚‹Istioã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€kube-apiserverãŒç‰¹å®šã®Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Serviceã«Webhookã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ğŸ‰â†ªï¸ï¼šIstio / Safely upgrade the Istio control plane with revisions and tagsã€ï¼’ã€‘æ–°Istiodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ãã‚Œã§ã¯ã€æ–°Istiodã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚â†ªï¸ï¼šControl planeistioctl versionã‚³ãƒãƒ³ãƒ‰æ–°ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹Istiodã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€istioctlã‚³ãƒãƒ³ãƒ‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æ±ºã¾ã‚Šã¾ã™ã€‚ãã“ã§ã€istioctl versionã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã“ã‚Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¾ã™ã€‚$ istioctl versionclient version: 1.15.4        # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å…ˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³control plane version: 1.14.6 # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³data plane version: 1.14.6istioctl installã‚³ãƒãƒ³ãƒ‰ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å ´åˆã€istioctl installã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯revisionã‚­ãƒ¼ã®å€¤ãŒcanaryã§ã™ãŒã€ä»Šå›ã¯1-15-4ã¨ã—ã¾ã™ã€‚ã“ã®å€¤ã¯ã€IstioãŒä½¿ç”¨ã™ã‚‹æ§˜ã€…ãªKubernetesãƒªã‚½ãƒ¼ã‚¹ã®æ¥å°¾è¾ã‚„ã€å„ç¨®ãƒªã‚½ãƒ¼ã‚¹ã®istio.io/revãƒ©ãƒ™ãƒ«ã®å€¤ã«ãªã‚Šã¾ã™ã€‚$ istioctl install --set revision=1-15-4WARNING: Istio is being upgraded from 1.14.6 -\u003e 1.15.4WARNING: Before upgrading, you may wish to use 'istioctl analyze' to check for IST0002 and IST0135 deprecation warnings.âœ… Istio core installedâœ… Istiod installedâœ… Ingress gateways installedâœ… Installation completeThank you for installing Istio 1.15.  Please take a few minutes to tell us about your install/upgrade experience!kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentkubectl getã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€istioctl installã‚³ãƒãƒ³ãƒ‰ã§ä½•ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã‹ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€1-15-4ã¨ã„ã†DeploymentãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚$ kubectl get deployment -n istio-system -l app=istiodNAME            READY   UP-TO-DATE   AVAILABLE   AGEistiod-1-14-6   1/1     1            1           47s # 1-14-6istiod-1-15-4   1/1     1            1           47s # 1-15-4æ¥å°¾è¾ã®1-15-4ã¯ã€revisionã‚­ãƒ¼ã®å€¤ã§æ±ºã¾ã‚Šã¾ã™ã€‚ã“ã®æ®µéšã§ã¯ã€æ—§Istiodã¨æ–°IstioãŒä¸¦è¡Œçš„ã«ç¨¼åƒã—ã¦ãŠã‚Šã€kube-apiserverã¯ã¾ã æ—§Istiodã¨é€šä¿¡ã—ã¦ã„ã¾ã™ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡â–¼ Webhookã®å®›å…ˆã®Serviceæ¬¡ã« Webhookã®å®›å…ˆã®Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€istiod-1-15-4ã¨ã„ã†ServiceãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚$ kubectl get service -n istio-system -l app=istiodNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGEistiod-1-14-6   ClusterIP   10.96.93.151     \u003cnone\u003e        15010/TCP,15012/TCP,443/TCP,15014/TCP   109s # 1-14-6istiod-1-15-4   ClusterIP   10.104.186.250   \u003cnone\u003e        15010/TCP,15012/TCP,443/TCP,15014/TCP   87s  # 1-15-4ã“ã®æ®µéšã§ã¯ã€ã¾ã Webhookã®å®›å…ˆã¯istiod-1-14-6ã®Serviceã§ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡â–¼ Webhookã®å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfigurationæœ€å¾Œã«MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€istio-sidecar-injector-1-15-4ã¨ã„ã†MutatingWebhookConfigurationãŒæ–°ã—ãå¢—ãˆã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfigurationsNAME                            WEBHOOKS   AGEistio-revision-tag-default      2          114s  # ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ä½¿ç”¨ã™ã‚‹istio-sidecar-injector-1-14-6   2          2m16sistio-sidecar-injector-1-15-4   2          2m16sã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã¯ã€istio-revision-tag-\u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003eã®MutatingWebhookConfigurationã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼“ã€‘Webhookã®å®›å…ˆã®Serviceã®å¤‰æ›´ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ã“ã®æ‰‹é †ã§ã¯ã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®istio.io/tagãƒ©ãƒ™ãƒ«ã¯ãã®ã¾ã¾ã«ã€istio.io/revãƒ©ãƒ™ãƒ«ã®å€¤ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ã•ã‚‰ã«ã€Webhookã®å®›å…ˆã®Serviceã‚’å¤‰æ›´ã—ã¾ã™ã€‚â†ªï¸ï¼šDefault tagSafely upgrade the Istio control plane with revisions and tagsistioctl tag setã‚³ãƒãƒ³ãƒ‰istioctl tag setã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€istio.io/revãƒ©ãƒ™ãƒ«ã®å€¤ã¨å®›å…ˆã®Serviceã‚’å¤‰æ›´ã—ã¾ã™ã€‚$ istioctl tag set default --revision 1-15-4 --overwriteå®Ÿè¡Œå¾Œã«ã€ã‚‚ã†ä¸€åº¦MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€istio.io/revãƒ©ãƒ™ãƒ«ã®å€¤ãŒå¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \\    | yq '.metadata.labels'...istio.io/rev: 1-15-4istio.io/tag: default...ã¾ãŸã€Webhookã®å®›å…ˆã®Serviceã‚‚å¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yaml \\    | yq '.webhooks[].clientConfig'...service:  name: istiod-1-15-4...ã“ã‚Œã‚‰ã«ã‚ˆã‚Šã€Webhookã®å®›å…ˆãŒ1-15-4ã®Serviceã¨ãªã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€1-15-4ã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼”ã€‘IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨Webhookã®å®›å…ˆãŒ1-15-4ã®Serviceã«å¤‰ã‚ã£ãŸã¨ã“ã‚ã§ã€IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚â†ªï¸ï¼šIn place upgradekubectl rollout restartã‚³ãƒãƒ³ãƒ‰kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€IngressGatewayã‚’ã‚¤ãƒ³ãƒ—ãƒ¬ãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚$ kubectl rollout restart deployment istio-ingressgateway-n istio-ingresså†ä½œæˆã—ãŸPodã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’1-15-4ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã™ã€‚$ kubectl get pod bar -n bar -o yaml | yq '.spec.containers[].image'docker.io/istio/proxyv2:1.15.4 # istio-proxyã‚³ãƒ³ãƒ†ãƒŠkubectl getã‚³ãƒãƒ³ãƒ‰ã®ä»£ã‚ã‚Šã«ã€istioctl proxy-statusã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å®Œäº†ã‚’ç¢ºèªã—ã¦ã‚‚ã‚ˆã„ã§ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼•ã€‘ä¸€éƒ¨ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨ç¶šã‘ã¦ã€ä¸€éƒ¨ã®Namespaceã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚Podã®å†ä½œæˆã«ã‚ˆã‚Šã€æ–°Istiodã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ãŸã‚ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚â†ªï¸ï¼šData planekubectl rollout restartã‚³ãƒãƒ³ãƒ‰å‰æã«ã‚ã‚‹ã‚ˆã†ã«ã€Namespaceã«ã¯ foo bar baz ãŒã‚ã‚Šã¾ã™ã€‚kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€barã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚$ kubectl rollout restart deployment bar -n barå†ä½œæˆã—ãŸPodã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã¿ã‚‹ã¨ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’1-15-4ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ãã¦ã„ã¾ã™ã€‚$ kubectl get pod bar -n bar -o yaml | yq '.spec.containers[].image'bar-app:1.0 # ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹docker.io/istio/proxyv2:1.15.4 # istio-proxyã‚³ãƒ³ãƒ†ãƒŠkubectl getã‚³ãƒãƒ³ãƒ‰ã®ä»£ã‚ã‚Šã«ã€istioctl proxy-statusã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®å®Œäº†ã‚’ç¢ºèªã—ã¦ã‚‚ã‚ˆã„ã§ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼–ã€‘ãƒ¦ãƒ¼ã‚¶ã®æ‰‹ã‚’å€Ÿã‚ŠãŸãƒ†ã‚¹ãƒˆã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨Istioã‚’éƒ¨åˆ†çš„ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ãŸã¨ã“ã‚ã§ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸNamespaceã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹ã‚’å€Ÿã‚Šã¦å®Ÿåœ°çš„ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™ (ä¾‹ï¼šè©²å½“ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒåŸºæº–å€¤ã‚’æº€ãŸã™ã‹) ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã‚‚ã—å•é¡ŒãŒèµ·ã“ã£ãŸå ´åˆã‚‚ã—å•é¡ŒãŒèµ·ã“ã£ãŸå ´åˆã€1-14-6ã«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚istioctl tag setã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€istio.io/revãƒ©ãƒ™ãƒ«ã®å€¤ã‚’å…ƒã«æˆ»ã—ã¾ã™ã€‚$ istioctl tag set default --revision 1-14-6 --overwriteãã®å¾Œã€kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã®æ‰‹é †ã‚’å®Ÿè¡Œã—ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã¾ã™ã€‚ã€ï¼—ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®æ®µéšçš„ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨å…ˆã»ã©ã®Namespaceã§å•é¡ŒãŒèµ·ã“ã‚‰ãªã‘ã‚Œã°ã€æ®‹ã£ãŸNamespace (fooã€bazã€...) ã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚‚æ®µéšçš„ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ã„ãã¾ã™ã€‚kubectl rollout restartã‚³ãƒãƒ³ãƒ‰åŒæ§˜ã«kubectl rollout restartã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¾ã™ã€‚$ kubectl rollout restart deployment foo -n foo$ kubectl rollout restart deployment baz -n baz...æœ€çµ‚çš„ã«ã€å…¨ã¦ã®Namespacemã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒæ–°ã—ããªã‚Šã¾ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼˜ã€‘æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã“ã“ã§å®Ÿæ–½ã™ã‚‹ã“ã¨æœ€å¾Œã«ã€æ—§Istiodã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚â†ªï¸ï¼šUninstall old control planeistioctl uninstallã‚³ãƒãƒ³ãƒ‰istioctl uninstallã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€æ—§Istiodã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚$ istioctl uninstall --revision 1-14-6âœ… Uninstall completeä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡kubectl getã‚³ãƒãƒ³ãƒ‰â–¼ Istiodã®Deploymentkubectl getã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€istioctl uninstallã‚³ãƒãƒ³ãƒ‰ã§ä½•ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã®ã‹ã‚’ç¢ºèªã—ã¾ã™ğŸ‘€ã¾ãšã¯Istiodã®Deploymentã‚’ç¢ºèªã™ã‚‹ã¨ã€1-14-6ã¨ã„ã†DeploymentãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚$ kubectl get deployment -n istio-system -l app=istiodNAME            READY   UP-TO-DATE   AVAILABLE   AGEistiod-1-15-4   1/1     1            1           47s # 1-15-4â–¼ Webhookã®å®›å…ˆã®Serviceæ¬¡ã« Webhookã®å®›å…ˆã®Serviceã‚’ç¢ºèªã™ã‚‹ã¨ã€istiod-1-14-6ã¨ã„ã†ServiceãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚$ kubectl get service -n istio-system -l app=istiodNAME            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                 AGEistiod-1-15-4   ClusterIP   10.104.186.250   \u003cnone\u003e        15010/TCP,15012/TCP,443/TCP,15014/TCP   87s  # 1-15-4â–¼ å®›å…ˆã®Serviceã‚’æ±ºã‚ã‚‹MutatingWebhookConfigurationæœ€å¾Œã«MutatingWebhookConfigurationã‚’ç¢ºèªã™ã‚‹ã¨ã€istio-sidecar-injector-1-14-6ã¨ã„ã†MutatingWebhookConfigurationãŒç„¡ããªã£ã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfigurationsNAME                            WEBHOOKS   AGEistio-revision-tag-default      2          114s  # æ¬¡ã®ã‚«ãƒŠãƒªã‚¢ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã§ã‚‚ä½¿ç”¨ã™ã‚‹istio-sidecar-injector-1-15-4   2          2m16sã“ã‚Œã§ã€æ–°Istiodã«å®Œå…¨ã«å…¥ã‚Œæ›¿ã‚ã£ãŸãŸã‚ã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã¯å®Œäº†ã§ã™ã€‚ä»Šã®çŠ¶æ³ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡05. ãŠã‚ã‚Šã«Istioã®å®‰å…¨ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹æ³•ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚Istioã¸ã®æ„›ãŒæº¢ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚Istioã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã®ç•°å¸¸ãŒã‚·ã‚¹ãƒ†ãƒ ã«ä¸ãˆã‚‹å½±éŸ¿åŠ›ã¯éå¸¸ã«å¤§ããã€æ§˜ã€…ãªå•é¡Œ (ä½“é¨“è«‡ï¼šistio-proxyã‚³ãƒ³ãƒ†ãƒŠã®Podã¸ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒãšã£ã¨å®Œäº†ã›ãšã€ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã§ããªã„) ãŒèµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ğŸ˜‡ã“ã‚Œã‹ã‚‰Istioã‚’æ¡ç”¨äºˆå®šã®æ–¹ã¯ã€Istioã‚’å®‰å…¨ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«ååˆ†ã«æº–å‚™ã—ã¦ãŠãã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ğŸ‘","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2023/02/26/202548","isoDate":"2023-02-26T11:25:48.000Z","dateMiliSeconds":1677410748000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"},{"title":"ã€Istioâ›µï¸ã€‘Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿","contentSnippet":"01. ã¯ã˜ã‚ã«02. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãªãœã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ãªã®ã‹ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥03. admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã«ã¤ã„ã¦admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã¯admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã¯AdmissionReviewã€AdmissionRequestã€AdmissionResponseâ–¼ AdmissionReviewâ–¼ AdmissionRequestâ–¼ AdmissionResponse04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼‘ã€‘Podã®ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆkube-apiserver â¡ï¸ Serviceã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼’ã€‘èªè¨¼/èªå¯å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã€ï¼“ã€‘ã‚¢ãƒ‰ã‚ªãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã€ï¼”ã€‘AdmissionRequestã«å€¤ã‚’è©°ã‚ã‚‹ã€ï¼•ã€‘AdmissionReviewã‚’é€ä¿¡Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼–ã€‘15017ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°kube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ (â€»é€†å‘ãã®çŸ¢å°)ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼—ã€‘patchå‡¦ç†ã‚’å®šç¾©ã€ï¼˜ã€‘AdmissionResponseã«å€¤ã‚’è©°ã‚ã‚‹ã€ï¼™ã€‘AdmissionReviewã‚’è¿”ä¿¡kube-apiserver â¡ï¸ etcdã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼‘ï¼ã€‘patchå‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã€ï¼‘ï¼‘ã€‘ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ï¼‘ï¼’ã€‘ã‚³ãƒ¼ãƒ«å®Œäº†ã‚’è¿”ä¿¡ä»¥é™ã®ä»•çµ„ã¿05. ãŠã‚ã‚Šã«01. ã¯ã˜ã‚ã«ã©ãƒ¼ã‚‚ã€‚æ­£æœˆã§æ¿€å¤ªã‚Šã—ã¾ã—ãŸãŒã€ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“ğŸ™‹ğŸ»â€ã•ã¦ã€å‰å›ã®è¨˜äº‹ã®æ™‚ã¨åŒæ§˜ã«ã€æœ€è¿‘ã®æ¥­å‹™ã§ã‚‚ã‚ªãƒ³ãƒ—ãƒ¬ã¨AWSä¸Šã®Istioã‚’ã²ãŸã™ã‚‰å­å®ˆã‚Šã—ã¦ã„ã¾ã™ã€‚å­å®ˆã‚Šã®å‰æçŸ¥è­˜ã®å¾©ç¿’ã‚‚ã‹ã­ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜äº‹ã§è§£èª¬ã—ã¾ã—ãŸğŸš€åŸ·ç­†æ™‚ç‚¹ (2023/01/14) ã§ã¯ã€IstioãŒå®Ÿè£…ã™ã‚‹ã‚µãƒ¼ãƒ“ãƒ¡ãƒƒã‚·ãƒ¥ã«ã¯ã€ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã€ã¨ã€ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ¡ãƒƒã‚·ãƒ¥ã€ãŒã‚ã‚Šã¾ã™ã€‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã®ä»•çµ„ã¿ã®è»¸ã«ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã§ã‚ã‚‹istio-proxyã‚³ãƒ³ãƒ†ãƒŠã§ã™ã€‚Istioã¯ã€Kubernetesã®Podã®ä½œæˆæ™‚ã«ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’Podå†…ã«è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ (æ³¨å…¥) ã—ã¾ã™æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—02. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãªãœã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ãªã®ã‹ãã‚‚ãã‚‚ã€ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãŒå¿…è¦ã«ãªã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ã‚·ã‚¹ãƒ†ãƒ ã«ã¯ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›ºæœ‰ã®ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œ (ä¾‹ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®å¿…è¦æ€§ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®æš—å·åŒ–ã€ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ä½œæˆã€ãªã©) ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒå„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å†…ã«ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã«é–¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚Œã°ã€ã“ã‚Œã‚‰ã®å•é¡Œã®è§£æ±ºã§ãã¾ã™ã€‚ã—ã‹ã—ã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ã‚¢ãƒ—ãƒªé ˜åŸŸã®å•é¡Œã«è²¬å‹™ã‚’æŒã¡ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§è§£æ±ºã™ã‚‹ã‚ˆã†ã«ã—ãŸæ–¹ãŒã€äº’ã„ã«åŠ¹ç‡çš„ã«é–‹ç™ºã§ãã¾ã™ã€‚ãã“ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦åˆ‡ã‚Šåˆ†ã‘ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è²¬å‹™ã‚’åˆ†é›¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€å‡é›†åº¦ãŒé«˜ããªã‚‹ã€‚ã¾ãŸã€ã‚¤ãƒ³ãƒ•ãƒ©é ˜åŸŸã®å…±é€šãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«æä¾›ã§ãã‚‹ãŸã‚ã€å˜ç´”æ€§ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ã“ã†ã„ã£ãŸæµã‚Œã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ãŒç™»å ´ã—ã¾ã—ãŸã€‚â†ªï¸ï¼šservicemesh.es | Service Mesh ComparisonWhat is Service Mesh and Why is it Necessary?ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ (ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥) ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ (istio-proxyã‚³ãƒ³ãƒ†ãƒŠ) ãŒç¨¼åƒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ä¸­å¤®é›†æ¨©çš„ã«ç®¡ç†ã™ã‚‹Istiod (discoveryã‚³ãƒ³ãƒ†ãƒŠ) ãŒç¨¼åƒã™ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‹ã‚‰ãªã‚Šã¾ã™ã€‚â†ªï¸ï¼šIstio / Architecture03. admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã«ã¤ã„ã¦admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã¯Istioã®Podå†…ã¸ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å‰æçŸ¥è­˜ã¨ã—ã¦ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ç†è§£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã—ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€ 04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ ã¾ã§é£›ã°ã—ã¦ãã ã•ã„ğŸ™‡ğŸ»â€kube-apiserverã§ã¯ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã¨ã—ã¦æœ‰åŠ¹åŒ–ã§ãã¾ã™ã€‚æœ‰åŠ¹åŒ–ã™ã‚‹ã¨ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã®å¾Œã«mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã¨validating-admissionã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã§ãã€admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡ã«å¿œã˜ãŸå‡¦ç†ã‚’æŒ¿å…¥ã§ãã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (kubectlã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€Kubernetesãƒªã‚½ãƒ¼ã‚¹) ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ (ä¾‹ï¼šKubernetesãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹ä½œæˆ/æ›´æ–°/å‰Šé™¤ã€kube-apiserverã‹ã‚‰ã®ãƒ—ãƒ­ã‚­ã‚·ã¸ã®è»¢é€) æ™‚ã«ã€å„ã‚¹ãƒ†ãƒƒãƒ—ã§admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã‚ˆã‚‹å‡¦ç† (ä¾‹ï¼šã‚¢ãƒ‰ã‚ªãƒ³ãƒ“ãƒ«ãƒˆã‚¤ãƒ³å‡¦ç†ã€ç‹¬è‡ªå‡¦ç†) ã‚’ç™ºç«ã•ã›ã‚‰ã‚Œã¾ã™ã€‚â†ªï¸ï¼šAdmission Controllers Reference | KubernetesKubernetes Best Practices: Blueprints for Building Successful Applications on Kubernetes: Burns, Brendan, Villalba, Eddie, Strebel, Dave, Evenson, Lachlan: 9781492056478: Amazon.com: Booksadmissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç¨®é¡admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®admissionãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¯ã€ãŸãã•ã‚“ã®ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚IstioãŒPodå†…ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã™ã‚‹æ™‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¢ãƒ‰ã‚ªãƒ³ã¯ã€ã€MutatingAdmissionWebhookã€ã§ã™ã€‚CertificateApprovalCertificateSigningCertificateSubjectRestrictionDefaultIngressClassDefaultStorageClassDefaultTolerationSecondsLimitRangerMutatingAdmissionWebhook ğŸ‘ˆ ã“ã‚Œï¼NamespaceLifecyclePersistentVolumeClaimResizePodSecurityPriorityResourceQuotaRuntimeClassServiceAccountStorageObjectInUseProtectionTaintNodesByConditionValidatingAdmissionWebhookâ†ªï¸ï¼šAdmission Controllers Reference | KubernetesMutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã¯MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—æ™‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†ã‚’ãƒ•ãƒƒã‚¯ã§ãã¾ã™ã€‚ãƒ•ãƒƒã‚¯ã™ã‚‹å…·ä½“çš„ãªå‡¦ç†ã¨ã—ã¦ã€webhookã‚µãƒ¼ãƒãƒ¼ã«AdmissionRequestãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦é€ä¿¡ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’å‹•çš„ã«å¤‰æ›´ã—ã¾ã™ã€‚MutatingWebhookConfigurationã§ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚MutatingWebhookConfigurationã®å…·ä½“çš„ãªå®Ÿè£…ã«ã¤ã„ã¦ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚â†ªï¸ï¼šDiving into Kubernetes MutatingAdmissionWebhook | by Morven Cao | IBM Cloud | MediumKubernetes Admission Webhookè¦šæ›¸ã - gashirar's blogAdmission Webhookã‚’ä½œã£ã¦éŠã‚“ã§ã€ãã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã‚ˆã†ï¼ˆèª¬æ˜ç·¨ï¼‰AdmissionReviewã€AdmissionRequestã€AdmissionResponseâ–¼ AdmissionReviewAdmissionReviewã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã‚ã‚Šã€kube-apiserverã¨webhookã‚µãƒ¼ãƒãƒ¼ã®é–“ã§AdmissionRequestã¨AdmissionResponseã‚’é‹ã³ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {},  # AdmissionResponse  \"response\": {},}â†ªï¸ï¼šv1 package - k8s.io/api/admission/v1 - Go Packagesâ–¼ AdmissionRequestAdmissionRequestã¯ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚kube-apiserverãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰å—ä¿¡ã—ãŸæ“ä½œå†…å®¹ãŒæŒã¤ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ä¾‹ã§æŒ™ã’ãŸAdmissionRequestã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒDeploymentã‚’CREATEæ“ä½œã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ãŸã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {    ...    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"resource\": {      \"group\": \"apps\",      \"version\": \"v1\",      \"resource\": \"deployments\"    },    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"operation\": \"CREATE\",    ...  }}â†ªï¸ï¼šDynamic Admission Control | Kubernetesâ–¼ AdmissionResponseä¸€æ–¹ã§AdmissionResponseã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªJSONã§ã™ã€‚AdmissionResponseã«å¿œã˜ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå¤‰æ›´å‡¦ç†ã‚’patchã‚­ãƒ¼ã®å€¤ã«æŒã¡ã€ã“ã‚Œã¯base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionResponse  \"response\": {      \"uid\": \"\u003cvalue from request.uid\u003e\",      # å®›å…ˆã®webhookã‚µãƒ¼ãƒãƒ¼ãŒå—ä¿¡ã—ãŸã‹å¦ã‹ã‚’è¡¨ã™ã€‚      \"allowed\": true,      # Pathã«ã‚ˆã‚‹Patchå‡¦ç†ã‚’è¡Œã†ã€‚      \"patchType\": \"JSONPatch\",      # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚      \"patch\": \"W3sib3AiOiAiYWRkIiwgInBhdGgiOiAiL3NwZWMvcmVwbGljYXMiLCAidmFsdWUiOiAzfV0=\",    },}ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å€¤ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã¿ã‚‹ã¨ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªpatchå‡¦ç†ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚# patchã‚­ãƒ¼ã‚’base64æ–¹å¼ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå ´åˆ[{\"op\": \"add\", \"path\": \"/spec/replicas\", \"value\": 3}]ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«å¯¾ã™ã‚‹æ“ä½œ (op) ã€ã‚­ãƒ¼ (path) ã€å€¤ (value) ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚kube-apiserverãŒã“ã‚Œã‚’å—ä¿¡ã™ã‚‹ã¨ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ (.spec.replicas) ã«å€¤ (3) ã«è¿½åŠ ã—ã¾ã™ã€‚â†ªï¸ï¼šDynamic Admission Control | Kubernetes04. ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿å…¨ä½“ã®ãƒ•ãƒ­ãƒ¼å‰æçŸ¥è­˜ã‚’è¸ã¾ãˆãŸä¸Šã§ã€admission-controllersã‚¢ãƒ‰ã‚ªãƒ³ã®ä»•çµ„ã¿ã®ä¸­ã§ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒã©ã®ã‚ˆã†ã«Podã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã•ã‚Œã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚æœ€åˆã«ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)â†ªï¸ï¼šAmazon.co.jp: Istio in Action (English Edition) é›»å­æ›¸ç±: Posta, Christian E., Maloku, Rinor: æ´‹æ›¸ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¡ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼‘ã€‘Podã®ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¾ãšã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒkube-apiserverã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã¨ã“ã‚ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (Deploymentã€DaemonSetã€StatefulSetã€ã‚’å«ã‚€) ã¯ã€Podã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’kube-apiserverã«é€ä¿¡ã—ã¾ã™ã€‚ã“ã®æ™‚ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¯ã€ä»¥ä¸‹ã®é€šã‚Šã¨ã—ã¾ã™ã€‚# Podã‚’ä½œæˆã™ã‚‹ã€‚$ kubectl apply -f foo-pod.yaml# foo-pod.yamlãƒ•ã‚¡ã‚¤ãƒ«apiVersion: v1kind: Podmetadata:  name: foo-pod  namespace: foo-namespacespec:  containers:    - name: foo      image: foo:1.0.0      ports:        - containerPort: 80ã¾ãŸNamespaceã§ã¯ã€ã‚ã‚‰ã‹ã˜ã‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã¨ã—ã¾ã™ã€‚Istioã§ã¯v1.10ä»¥é™ã€ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®ç•ªå·ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚apiVersion: v1kind: Namespacemetadata:  name: foo-namespace  labels:    # istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã€‚    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯è‡ªç”±    istio.io/rev: \u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003eâ†ªï¸ï¼šIstio / Announcing Support for 1.8 to 1.10 Direct Upgradesistio.io/revãƒ©ãƒ™ãƒ«å€¤ã¯ã€ã©ã‚“ãªã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§ã‚‚è‰¯ã„ã§ã™ã€‚ã‚ˆãã‚ã‚‹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¨ã—ã¦defaultã‚„stableãªã©ã‚’ä½¿ç”¨ã—ã¾ã™ğŸ‘kube-apiserver â¡ï¸ Serviceã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¡ï¸ Serviceã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼’ã€‘èªè¨¼/èªå¯å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€èªè¨¼ã‚¹ãƒ†ãƒƒãƒ—ã¨èªå¯ã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™ã€‚ã€ï¼“ã€‘ã‚¢ãƒ‰ã‚ªãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«ã—ã¾ã™ã€‚å‰æçŸ¥è­˜ã®éƒ¨åˆ†ã§å…·ä½“çš„ãªå®Ÿè£…ã‚’çœç•¥ã—ã¾ã—ãŸãŒã€Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.14.3æ™‚ç‚¹ã§ã€MutatingWebhookConfigurationã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚Namespaceã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹æ™‚ã«ä½¿ç”¨ã—ãŸã‚¨ã‚¤ãƒªã‚¢ã‚¹ã¯ã€ã“ã®MutatingWebhookConfigurationã§å®Ÿä½“ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã¨ç´ã¥ã„ã¦ã„ã¾ã™ã€‚$ kubectl get mutatingwebhookconfiguration istio-revision-tag-default -o yamlapiVersion: admissionregistration.k8s.io/v1beta1kind: MutatingWebhookConfigurationmetadata:  name: istio-revision-tag-default  labels:    app: sidecar-injector    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®å®Ÿä½“    istio.io/rev: \u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003e    # ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹    istio.io/tag: \u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003ewebhooks:  - name: rev.namespace.sidecar-injector.istio.io    # MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã®ç™ºç«æ¡ä»¶ã‚’ç™»éŒ²ã™ã‚‹ã€‚    rules:      - apiGroups: [\"\"]        apiVersions: [\"v1\"]        operations: [\"CREATE\"]        resources: [\"pods\"]        scope: \"*\"    # Webhookã®å‰æ®µã«ã‚ã‚‹Serviceã®æƒ…å ±ã‚’ç™»éŒ²ã™ã‚‹ã€‚    clientConfig:      service:        name: istiod-\u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003e        namespace: istio-system        path: \"/inject\" # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ        port: 443      caBundle: Ci0tLS0tQk ...    # Namespaceå˜ä½ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³    # ç‰¹å®šã®Namespaceã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚    namespaceSelector:      matchExpressions:        - key: istio.io/rev          operator: DoesNotExist        - key: istio-injection          operator: DoesNotExist    # Podå˜ä½ã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³    # ç‰¹å®šã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å‡¦ç†ã‚’ç™ºç«ã•ã›ã‚‹ã€‚    objectSelector:      matchExpressions:        - key: sidecar.istio.io/inject          operator: NotIn          values:            - \"false\"        - key: istio.io/rev          operator: In          values:            - \u003cã‚¨ã‚¤ãƒªã‚¢ã‚¹\u003e    ...MutatingWebhookConfigurationã«ã¯ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã‚„webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã‚’å®šç¾©ã—ã¾ã™ã€‚MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®ç™ºç«æ¡ä»¶ã«é–¢ã—ã¦ã€ä¾‹ãˆã°Istioã§ã¯ã€ Namespaceã‚„Pod.metadata.labelsã‚­ãƒ¼ã«å¿œã˜ã¦ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã€ã“ã‚Œã‚’MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚webhookã‚µãƒ¼ãƒãƒ¼ã®å®›å…ˆæƒ…å ±ã«é–¢ã—ã¦ã€Istioã§ã¯webhookã‚µãƒ¼ãƒãƒ¼ã®å‰æ®µã«Serviceã‚’é…ç½®ã—ã¦ã„ã¾ã™ã€‚MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒç™ºç«ã—ãŸå ´åˆã€Serviceã®/inject:443ã«HTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ã¾ãŸã€å®›å…ˆã®Serviceã®åå‰ãŒistiod-\u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003eã¨ãªã£ã¦ã„ã‚‹ã“ã¨ã‹ã‚‰ã‚‚ã‚ã‹ã‚‹ã‚ˆã†ã«ã€Serviceã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Istiodã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã«å¯¾å¿œã—ã¦ãŠã‚Šã€æƒ³å®šå¤–ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Istiodã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’æŒ‡å®šã—ãªã„ã‚ˆã†ã«åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚ä¸€æ–¹ã§ç™ºç«ã—ãªã‹ã£ãŸå ´åˆã«ã¯ã€ä»¥é™ã®AdmissionReviewã®å‡¦ç†ã«ã¯é€²ã¿ã¾ã›ã‚“ã€‚ã€ï¼”ã€‘AdmissionRequestã«å€¤ã‚’è©°ã‚ã‚‹kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ (Podã®ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ) ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionRequestã«è©°ã‚ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionRequest  \"request\": {    ...    # å¤‰æ›´ã•ã‚Œã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"resource\": {      \"group\": \"core\",      \"version\": \"v1\",      \"resource\": \"pods\"    },    # kube-apiserverã®æ“ä½œã®ç¨®é¡ã‚’è¡¨ã™ã€‚    \"operation\": \"CREATE\",    ...  }}ã€ï¼•ã€‘AdmissionReviewã‚’é€ä¿¡kube-apiserverã¯ã€mutating-admissionã‚¹ãƒ†ãƒƒãƒ—ã«ã¦ã€Serviceã®/inject:443ã«AdmissionReviewæ§‹é€ ä½“ã‚’é€ä¿¡ã—ã¾ã™ã€‚Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€Service â¡ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼–ã€‘15017ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°Serviceã¯ã€/inject:443ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã®15017ç•ªãƒãƒ¼ãƒˆã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã—ã¾ã™ã€‚Istioã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³1.14.3æ™‚ç‚¹ã§ã€Serviceã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚$ kubectl get svc istiod-service -n istio-system -o yamlapiVersion: v1kind: Servicemetadata:  labels:    app: istiod  name: istiod-\u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003e  namespace: istio-systemspec:  type: ClusterIP  selector:    app: istiod    istio.io/rev: \u003cãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·\u003e  ports:    - name: grpc-xds      port: 15010      protocol: TCP      targetPort: 15010    - name: https-dns      port: 15012      protocol: TCP      targetPort: 15012    # webhookã‚µãƒ¼ãƒãƒ¼ã«ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã€‚    - name: https-webhook      port: 443      protocol: TCP      targetPort: 15017    - name: http-monitoring      port: 15014      protocol: TCP      targetPort: 15014.spec.selector.istio.io/revã‚­ãƒ¼ã«ã€ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å…ˆã®Podã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã®ãƒªãƒ“ã‚¸ãƒ§ãƒ³ç•ªå·ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€ã“ã®Podã¯discoveryã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚Istioã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã§webhookã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè¡Œã—ã€15017ç•ªãƒãƒ¼ãƒˆã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¾ã™ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€15017ç•ªãƒãƒ¼ãƒˆã§ãƒªãƒƒã‚¹ãƒ³ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ğŸ‘$ kubectl exec foo-istiod -n istio-system -- netstat -tulpnActive Internet connections (only servers)Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program nametcp        0      0 127.0.0.1:9876          0.0.0.0:*               LISTEN      1/pilot-discoverytcp6       0      0 :::15017                :::*                    LISTEN      1/pilot-discoverytcp6       0      0 :::8080                 :::*                    LISTEN      1/pilot-discoverytcp6       0      0 :::15010                :::*                    LISTEN      1/pilot-discoverytcp6       0      0 :::15012                :::*                    LISTEN      1/pilot-discoverytcp6       0      0 :::15014                :::*                    LISTEN      1/pilot-discoveryâ†ªï¸ï¼šistio/webhook.go at 1.14.3 Â· istio/istio Â· GitHubIstio / Application Requirementskube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ (â€»é€†å‘ãã®çŸ¢å°)ã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¬…ï¸ Service â¬…ï¸ webhookã‚µãƒ¼ãƒãƒ¼ã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚çŸ¢å°ãŒé€†å‘ããªã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼—ã€‘patchå‡¦ç†ã‚’å®šç¾©ä»•çµ„ã¿ã®ä¸­ã§ã‚‚ã€ã“ã“ã¯é‡è¦ãªéƒ¨åˆ†ã§ã™ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã®patchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®.spec.containers[1]ãƒ‘ã‚¹ã«istio-proxyã‚­ãƒ¼ã‚’è¿½åŠ ã•ã›ã‚‹ã‚ˆã†ãªpatchå‡¦ç†ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã®å®šç¾©ã«ã‚ˆã£ã¦ã€çµæœçš„ã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã®ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒèµ·ã“ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚[  ...  {    \"op\": \"add\",    # .spec.initContainers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚    \"path\": \"/spec/initContainers/1\",    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚    \"value\": {      \"name\": \"istio-init\",      \"resources\": {                     ...      }    }  },  {    \"op\": \"add\",    # .spec.containers[1] ã‚’æŒ‡å®šã™ã‚‹ã€‚    \"path\": \"/spec/containers/1\",    # ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã‚‹æ§‹é€ ã‚’è¡¨ã™ã€‚    \"value\": {      \"name\": \"istio-proxy\",      \"resources\": {                     ...      }    }  }  ...]â†ªï¸ï¼šistio/webhook.go at a19b2ac8af3ad937640f6e29eed74472034de2f5 Â· istio/istio Â· GitHubistio/webhook_test.go at 1.14.3 Â· istio/istio Â· GitHubã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€InitContainerã®istio-initã‚³ãƒ³ãƒ†ãƒŠã‚‚ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®istio-initã‚³ãƒ³ãƒ†ãƒŠã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¤Podã§ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰/ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®çµŒè·¯ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€Podå†…ã«iptablesã®ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ğŸ’ªğŸ»â†ªï¸ï¼šIstio Sidecar's interception mechanism for traffic - SoByteã€ï¼˜ã€‘AdmissionResponseã«å€¤ã‚’è©°ã‚ã‚‹discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReveiewæ§‹é€ ä½“ã®AdmissionResponseã«è©°ã‚ã¾ã™ã€‚patchã‚­ãƒ¼ã®å€¤ã«ã€å…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚{  \"apiVersion\": \"admission.k8s.io/v1\",  \"kind\": \"AdmissionReview\",  # AdmissionResponse  \"response\": {      \"uid\": \"*****\",      \"allowed\": true,      \"patchType\": \"JSONPatch\",      # Patchå‡¦ç†ã®å¯¾è±¡ã¨ãªã‚‹Kubernetesãƒªã‚½ãƒ¼ã‚¹ã¨å‡¦ç†å†…å®¹ã‚’è¡¨ã™ã€‚base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚      \"patch\": \"\u003cå…ˆã»ã©ã®patchå‡¦ç†ã®å®šç¾©ã‚’base64æ–¹å¼ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸæ–‡å­—åˆ—\u003e\",    },}â†ªï¸ï¼šistio/webhook.go at 1.14.3 Â· istio/istio Â· GitHubã€ï¼™ã€‘AdmissionReviewã‚’è¿”ä¿¡discoveryã‚³ãƒ³ãƒ†ãƒŠå†…ã®webhookã‚µãƒ¼ãƒãƒ¼ã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦kube-apiserverã«è¿”ä¿¡ã—ã¾ã™ã€‚kube-apiserver â¡ï¸ etcdã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€kube-apiserver â¡ï¸ etcdã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼‘ï¼ã€‘patchå‡¦ç†ã‚’ã‚³ãƒ¼ãƒ«kube-apiserverã¯ã€AdmissionReviewæ§‹é€ ä½“ã‚’å—ä¿¡ã—ã€AdmissionResponseã«å¿œã˜ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚patchå‡¦ç†ã®å®šç¾©ã‚’AdmissionReviewæ§‹é€ ä½“ã‹ã‚‰å–ã‚Šå‡ºã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¨istio-initã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®è©²å½“ç®‡æ‰€ã«ã‚­ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚apiVersion: v1kind: Podmetadata:  name: foo-pod  namespace: foo-namespacespec:  containers:    - name: foo      image: foo:1.0.0      ports:        - containerPort: 80    # kube-apiserverãŒè¿½åŠ     - name: istio-proxy      ...  # kube-apiserverãŒè¿½åŠ   initContainers:    - name: istio-init    ...ã€ï¼‘ï¼‘ã€‘ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–kube-apiserverã¯ã€etcdã«Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã“ã“ã§èª¬æ˜ã™ã‚‹ãƒ•ãƒ­ãƒ¼ç®‡æ‰€ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â¬…ï¸ kube-apiserverã€ã®ç®‡æ‰€ã‚’èª¬æ˜ã—ã¾ã™ã€‚(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)ã€ï¼‘ï¼’ã€‘ã‚³ãƒ¼ãƒ«å®Œäº†ã‚’è¿”ä¿¡kube-apiserverã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã—ã¾ã™ã€‚$ kubectl apply -f foo-pod.yaml# kube-apiserverã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹pod \"foo-pod\" createdä»¥é™ã®ä»•çµ„ã¿(ç”»åƒã¯ã‚¿ãƒ–é–‹ãé–²è¦§ã‚’æ¨å¥¨)kube-apiserverã¯ã€ä»–ã®Nodeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (kube-controlleretcdã€kube-schedulerã€kubeletã€ãªã©) ã¨é€šä¿¡ã—ã€Podã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®Podã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚³ãƒ³ãƒ†ãƒŠã®ä»–ã«ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¨istio-initã‚³ãƒ³ãƒ†ãƒŠã‚’æŒã¡ã¾ã™ã€‚çµæœã¨ã—ã¦ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®é€šä¿¡ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ãŒéå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸğŸ™‡ğŸ»â€â†ªï¸ï¼šKubernetes Master Components: Etcd, API Server, Controller Manager, and Scheduler | by Jorge Acetozi | jorgeacetozi | Medium05. ãŠã‚ã‚Šã«Istioã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ã‚’ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚Istioã¸ã®æ„›ãŒæº¢ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚ä»Šå›ç™»å ´ã—ãŸMutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«é–¢ã—ã¦ã€ç§ã®é–¢ã‚ã£ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯Istioä»¥å¤– (ä¾‹ï¼šCertManagerã€Prometheusã€AWSã®aws-eks-vpc-cniã‚¢ãƒ‰ã‚ªãƒ³ã€ãªã©) ã§ã‚‚ä½¿ç”¨ã—ã¦ã„ã¾ã™âœŒï¸ãã®ãŸã‚ã€MutatingAdmissionWebhookãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã©ã®ã‚ˆã†ã«ä½¿ã£ã¦ã„ã‚‹ã®ã‹ã‚’ä¸€åº¦çŸ¥ã‚Œã°ã€çŸ¥è­˜ã®æ±ç”¨æ€§ãŒé«˜ã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã¯Istioã§ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã§ã‚ã‚Šã€ã‚‚ã—æœªä½“é¨“ã®æ–¹ãŒã„ã‚‰ã£ã—ã‚ƒã‚Œã°ã€ãŠæ‰‹å…ƒã§ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãŒè¿½åŠ ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã„ãŸã ãã¨ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ğŸ‘","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2023/01/14/223815","isoDate":"2023-01-14T13:38:15.000Z","dateMiliSeconds":1673703495000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"},{"title":"ã€Istioâ›µï¸ã€‘Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿","contentSnippet":"01. ã¯ã˜ã‚ã«02. ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«ã¤ã„ã¦ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¨ã¯ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ãŒå¿…è¦ãªã®ã‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®è¦ç´ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³03. Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿å…¨ä½“åƒã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘discoveryã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿04. istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã®ä»•çµ„ã¿Envoyã®å‡¦ç†ã®æµã‚Œå…¨ä½“åƒã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘EnvoyãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã‚’è¦‹ã¦ã¿ã‚ˆã†config_dumpã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•â–¼ çµæœãƒ«ãƒ¼ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•â–¼ çµæœã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•â–¼ çµæœã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•â–¼ çµæœEnvoyã®å‡¦ç†ã®æµã‚Œã®ã¾ã¨ã‚ã€ï¼‘ã€‘ã€ï¼’ã€‘ã€ï¼“ã€‘ã€ï¼”ã€‘ã€ï¼•ã€‘ã€ï¼–ã€‘05. ãŠã‚ã‚Šã«è¬è¾01. ã¯ã˜ã‚ã«3-shake Advent Calender 2022 æœ€çµ‚æ—¥ã®è¨˜äº‹ã§ã™ğŸ…ç§ã¯æ™®æ®µã¯ ä¿ºã®æŠ€è¡“ãƒãƒ¼ãƒˆ ã«çŸ¥è¦‹ã‚’è¨˜éŒ²ã—ã¦ãŠã‚Šã€ã¯ã¦ãªãƒ–ãƒ­ã‚°ã¯ãƒ‡ãƒ“ãƒ¥ãƒ¼æˆ¦ã¨ãªã‚Šã¾ã™ã€‚æœ€è¿‘ã®æ¥­å‹™ã§ã€ã‚ªãƒ³ãƒ—ãƒ¬ã¨AWSä¸Šã®Istioã‚’ã²ãŸã™ã‚‰å­å®ˆã‚Šã—ã¦ã„ã¾ã™ã€‚å­å®ˆã‚Šã®å‰æçŸ¥è­˜ã®å¾©ç¿’ã‚‚ã‹ã­ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã‚’å®Ÿè£…ã™ã‚‹Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚’è¨˜äº‹ã§è§£èª¬ã—ã¾ã—ãŸğŸš€Istioã®æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã€ã®ä»•çµ„ã¿ã‚’ã€Envoyã‚’äº¤ãˆãªãŒã‚‰ã€ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¦ã„ãã¾ã™ğŸ˜—3-shake SRE Tech Talk ã§ç™ºè¡¨ã—ãŸå†…å®¹ã«åŠ ãˆã¦ã€ã‚¹ãƒ©ã‚¤ãƒ‰ã®ä½™ç™½ã¨ç™ºè¡¨æ™‚é–“ã®åˆ¶ç´„ã§è¨˜è¼‰ã§ããªã‹ã£ãŸã“ã¨ã‚‚è¨˜è¼‰ã—ã¾ã—ãŸã€‚02. ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«ã¤ã„ã¦ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¨ã¯ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å ´é¢ãŒã‚ã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¨ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆæƒ…å ± (ä¾‹ï¼šIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€å®Œå…¨ä¿®é£¾ãƒ‰ãƒ¡ã‚¤ãƒ³åã€ãªã©) ã‚’æ¤œå‡ºã—ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¶™ç¶šçš„ã«é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ã®ã“ã¨ã§ã™ã€‚ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ãŒå¿…è¦ãªã®ã‹ãã‚‚ãã‚‚ã€ãªãœã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ãŒå¿…è¦ãªã®ã§ã—ã‚‡ã†ã‹ã€‚ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ (å®šã‚ã‚‰ã‚ŒãŸæ¡ä»¶ä¸‹ã§å®šã‚ã‚‰ã‚ŒãŸæœŸé–“ã«ã‚ãŸã‚Šã€éšœå®³ã‚’ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ãªãå®Ÿè¡Œã™ã‚‹ç¨‹åº¦) ã‚’æ‹…ä¿ã™ã‚‹ãŸã‚ã«ã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’æ¡ç”¨ã—ã¾ã™ã€‚ã“ã®æ™‚ã€è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒå¢—åŠ ã™ã‚‹ãŸã³ã«ã€å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯æ–°ã—ã„å®›å…ˆæƒ…å ±ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã¾ãŸã€ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒä½œã‚Šç›´ã•ã‚ŒãŸå ´åˆã«ã‚‚ã€å®›å…ˆæƒ…å ±ã¯æ›´æ–°ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã€ãŸã¨ãˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®›å…ˆæƒ…å ±ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã—ã¦ã‚‚ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ãªã„ä»•çµ„ã¿ãŒå¿…è¦ã§ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®è¦ç´ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿ã¯ã€æ¬¡ã®è¦ç´ ã‹ã‚‰ãªã‚Šã¾ã™ã€‚åå‰è§£æ±ºã«é–¢ã—ã¦ã¯ã€DNSãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ (ä¾‹ï¼šCoreDNS + Service + kube-proxyã«ã‚ˆã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼) ã§å¿…è¦ã¨ãªã‚Šã€Istioã§ã¯ä½¿ã„ã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€æœ¬è¨˜äº‹ã§ã¯è¨€åŠã—ãªã„ã“ã¨ã¨ã—ã¾ã™ğŸ™‡ğŸ»â€ è¦ç´                     è²¬å‹™                                                                    é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹  ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚                                                  å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹    ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã™ã‚‹ã€‚                                                  ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒª      å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆæƒ…å ±ã‚’ä¿ç®¡ã™ã‚‹ã€‚                              ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼        å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹ã€‚            åå‰è§£æ±º                å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ã«ã€åå‰è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿ã«ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚Šã¾ã™ã€‚Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¯ã€ã“ã®ã†ã¡ã®ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã€å•ã„åˆã‚ã›ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã®è²¬å‹™ãŒåˆ‡ã‚Šé›¢ã•ã‚Œã¦ã„ã¾ã™ã€‚é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å•ã„åˆã‚ã›ã€ã¾ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ğŸ’ªğŸ»(ä¾‹) Istioã€Linkerdã€ãªã©â†ªï¸ï¼šAmazon.co.jp: Cloud Native Patterns: Designing change-tolerant software (English Edition) é›»å­æ›¸ç±: Davis, Cornelia: æ´‹æ›¸Server-side service discovery patternã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³é€šä¿¡ã®é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®å®›å…ˆã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«å•ã„åˆã‚ã›ã€ã•ã‚‰ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã„ã¾ã™ã€‚(ä¾‹) Netflixã®Eurekaã€ãªã©â†ªï¸ï¼šAmazon.co.jp: Cloud Native Patterns: Designing change-tolerant software (English Edition) é›»å­æ›¸ç±: Davis, Cornelia: æ´‹æ›¸Client-side service discovery patternService Discovery in Kubernetes: Combining the Best of Two Worlds03. Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®ä»•çµ„ã¿IstioãŒå®Ÿè£…ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ãƒƒã‚·ãƒ¥ã«ã¯ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã¨ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆãƒ¡ãƒƒã‚·ãƒ¥ãŒã‚ã‚Šã€ä»Šå›ã¯ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ãƒ¡ãƒƒã‚·ãƒ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚’å–ã‚Šä¸Šã’ã¾ã™ã€‚Istioã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã¨istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒè»¸ã¨ãªã‚Šã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å…¨ä½“åƒã€ï¼‘ã€‘ã€œã€ï¼–ã€‘ã®å…¨ä½“åƒã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®å•ã„åˆã‚ã›ã¨ã€ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã‚‹ã“ã¨ã«æ³¨ç›®ã—ã¦ãã ã•ã„ã€‚ã€ï¼‘ã€‘kube-apiserverã¯ã€Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’etcdç­‰ã«ä¿ç®¡ã—ã¾ã™ã€‚ã“ã‚Œã¯ã€Kubernetesã®é€šå¸¸ã®ä»•çµ„ã¿ã§ã™ã€‚ã€ï¼’ã€‘discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€kube-apiserverã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã€è‡ªèº«ã«ä¿ç®¡ã—ã¾ã™ã€‚ã€ï¼“ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€discoveryã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§å–å¾—ã—ã¾ã™ã€‚ã€ï¼”ã€‘é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®è²¬å‹™é€šã‚Šã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ (ã“ã“ã§ã¯istio-proxyã‚³ãƒ³ãƒ†ãƒŠ) ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã“ã®æ™‚ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒistio-proxyã‚³ãƒ³ãƒ†ãƒŠã«ç›´æ¥çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ã€iptablesãŒistio-proxyã‚³ãƒ³ãƒ†ãƒŠã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã“ã‚Œã‚’å—ä¿¡ã—ã¾ã™ã€‚ã€ï¼•ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã€å®›å…ˆPodã«ã“ã‚Œã‚’é€ä¿¡ã—ã¾ã™ã€‚â†ªï¸ï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software DevelopmentJimmy Song - ä¸“æ³¨äºæ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼Tech-èµµåŒ–å†°çš„åšå®¢ | Zhaohuabing Blogdiscoveryã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿discoveryã‚³ãƒ³ãƒ†ãƒŠã‚’è©³ã—ãè¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€åˆ¥åIstiodã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚XDS-APIã¨ã„ã†ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å…¬é–‹ã—ã¦ãŠã‚Šã€XDS-APIã®ã†ã¡ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã«é–¢ä¿‚ã™ã‚‹APIã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ APIã®ç¨®é¡  èª¬æ˜                                                   LDS-API    Envoyã®ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                        RDS-API    Envoyã®ãƒ«ãƒ¼ãƒˆå€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                          CDS-API    Envoyã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’å–å¾—ã§ãã‚‹ã€‚                      EDS-API    Envoyã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã§ãã‚‹ã€‚                        ADS-API    å„XDS-APIã‹ã‚‰å–å¾—ã§ãã‚‹å®›å…ˆæƒ…å ±ã‚’æ•´ç†ã—ã¦å–å¾—ã§ãã‚‹ã€‚ discoveryã‚³ãƒ³ãƒ†ãƒŠã¯ã€kube-apiserverã‹ã‚‰Podç­‰ã®å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã¦è‡ªèº«ã®ãƒ¡ãƒ¢ãƒªä¸Šã«ä¿ç®¡ã—ã€å„XDS-APIã‹ã‚‰æä¾›ã—ã¾ã™ã€‚XDS-APIã¨istio-proxyã‚³ãƒ³ãƒ†ãƒŠã®é–“ã§ã¯ã€gRPCã®åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã®æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ã¦å®›å…ˆæƒ…å ±ã‚’è¿”å´ã™ã‚‹ã ã‘ã§ãªãã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªãã¨ã‚‚ã€XDS-APIã‹ã‚‰ã‚‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦å®›å…ˆæƒ…å ±ã‚’é€ä¿¡ã—ã¾ã™ã€‚å„ç¨®XDS-APIã‹ã‚‰å€‹åˆ¥ã«å®›å…ˆæƒ…å ±ã‚’å–å¾—ã§ãã¾ã™ãŒã€Envoyä¸Šã§å®›å…ˆæƒ…å ±ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¸æ•´åˆãŒèµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€Istioã§ã¯å®Ÿéš›ã«ã¯ADS-APIã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚â†ªï¸ï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software Developmentistio-proxyã‚³ãƒ³ãƒ†ãƒŠã®ä»•çµ„ã¿istio-proxyã‚³ãƒ³ãƒ†ãƒŠã‚’è©³ã—ãè¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠã§ã¯ã€pilot-agentã¨EnvoyãŒç¨¼åƒã—ã¦ã„ã¾ã™ã€‚å…ˆã»ã©istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§ADS-APIã‹ã‚‰å®›å…ˆæƒ…å ±ã‚’å–å¾—ã™ã‚‹ã¨èª¬æ˜ã—ã¾ã—ãŸã€‚å³å¯†ã«ã¯EnvoyãŒã€pilot-agentã‚’ä»‹ã—ã¦ã€ADS-APIã‹ã‚‰åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°RPCã§å®›å…ˆæƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒé€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã™ã‚‹ã¨ã€Envoyã¯ADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã«åŸºã¥ã„ã¦ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã¾ã™ã€‚â†ªï¸ï¼šAmazon | Istio in Action | Posta, Christian E., Maloku, Rinor | Software DevelopmentJimmy Song - ä¸“æ³¨äºæ¢ç´¢å Kubernetes æ—¶ä»£çš„äº‘åŸç”Ÿæ–°èŒƒå¼Tech-èµµåŒ–å†°çš„åšå®¢ | Zhaohuabing Blog04. istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã®ä»•çµ„ã¿Envoyã®å‡¦ç†ã®æµã‚ŒEnvoyãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã‚’è¦‹ã¦ã„ãå‰ã«ã€Envoyã®å‡¦ç†ã®æµã‚Œã‚’è§£èª¬ã—ã¾ã™ã€‚istio-proxyã‚³ãƒ³ãƒ†ãƒŠå†…ã®Envoyã§ã¯ã€ä»¥ä¸‹ã®ä»•çµ„ã¿ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚å…¨ä½“åƒã€ï¼‘ã€‘ã€œã€ï¼–ã€‘ã®å…¨ä½“åƒã¯ã€ä»¥ä¸‹ã®é€šã‚Šã§ã™ğŸ‘‡ã€ï¼‘ã€‘istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã€é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ä¿¡ã—ã¾ã™ã€‚ã€ï¼’ã€‘Envoyã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®›å…ˆæƒ…å ± (ä¾‹ï¼šå®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç•ªå·ã€ãƒ‘ã‚¹ã€ãƒ›ã‚¹ãƒˆã€ãªã©) ã«å¿œã˜ã¦ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼“ã€‘Envoyã¯ã€ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼”ã€‘Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼•ã€‘Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼–ã€‘Envoyã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã«å¯¾å¿œã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚Envoyã§ç¢ºèªã—ãŸå®›å…ˆæƒ…å ±ã‚’ğŸ‘†ã«å½“ã¦ã¯ã‚ã¦è¦‹ã¦ã„ãã“ã¨ã«ã—ã¾ã—ã‚‡ã†ã€‚â†ªï¸ï¼šAmazon.co.jp: Istio in Action (English Edition) é›»å­æ›¸ç±: Posta, Christian E., Maloku, Rinor: æ´‹æ›¸Amazon | Istio: Up and Running: Using a Service Mesh to Connect, Secure, Control, and Observe | Calcote, Lee, Butcher, Zack | Design Tools \u0026 TechniquesArchitecture Analysis of Istio: The Most Popular Service Mesh Project - Alibaba Cloud CommunityEnvoyãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸå®›å…ˆæƒ…å ±ã‚’è¦‹ã¦ã¿ã‚ˆã†config_dumpã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿéš›ã«Envoyã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å®›å…ˆæƒ…å ±ã¯ã€istio-proxyã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®localhost:15000/config_dumpã‹ã‚‰JSONã§å–å¾—ã§ãã¾ã™ã€‚ã‚‚ã—ãŠæ‰‹å…ƒã«IstioãŒã‚ã‚‹å ´åˆã¯ã€Envoyã«ã©ã‚“ãªå®›å…ˆæƒ…å ±ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã€Envoyã‚’å†’é™ºã—ã¦ã¿ã¦ãã ã•ã„ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump\" | yq -PJSONã ã¨è¦‹ã«ãã„ã®ã§ã€yqã‚³ãƒãƒ³ãƒ‰ã§YAMLã«å¤‰æ›ã™ã‚‹ã¨è¦‹ã‚„ã™ããªã‚Šã¾ã™ğŸ‘ãƒªã‚¹ãƒŠãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒŠãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_listeners}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_listeners}\" | yq -Pâ–¼ çµæœä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚å®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„å®›å…ˆãƒãƒ¼ãƒˆç•ªå·ã«å¿œã˜ã¦ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€ã“ã“ã§ã¯\u003cä»»æ„ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹\u003e:50002ã€‚ãƒªã‚¹ãƒŠãƒ¼å€¤ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã®åå‰configs:  - \"@type\": type.googleapis.com/envoy.admin.v3.ListenersConfigDump.DynamicListener    # ãƒªã‚¹ãƒŠãƒ¼å    name: 0.0.0.0_50002    active_state:      version_info: 2022-11-24T12:13:05Z/468      listener:        \"@type\": type.googleapis.com/envoy.config.listener.v3.Listener        name: 0.0.0.0_50002        address:          socket_address:            # å—ä¿¡ã—ãŸãƒ‘ã‚±ãƒƒãƒˆã®ã†ã¡ã§ã€å®›å…ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°            address: 0.0.0.0            # å—ä¿¡ã—ãŸãƒ‘ã‚±ãƒƒãƒˆã®ã†ã¡ã§ã€å®›å…ˆãƒãƒ¼ãƒˆç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°            port_value: 50002        filter_chains:          - filter_chain_match:              transport_protocol: raw_buffer              application_protocols:                - http/1.1                - h2c            filters:              - name: envoy.filters.network.http_connection_manager                typed_config:                  \"@type\": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager                  stat_prefix: outbound_0.0.0.0_50001                  rds:                    config_source:                      ads: {}                      initial_fetch_timeout: 0s                      resource_api_version: V3                    # æœ¬ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ããƒ«ãƒ¼ãƒˆå€¤ã®åå‰                    route_config_name: 50002  ...  - \"@type\": type.googleapis.com/envoy.admin.v3.ListenersConfigDump.DynamicListener  ...â†ªï¸ï¼šAdministration interface â€” envoy 1.27.0-dev-f12afb documentationConfigDump (proto) â€” envoy 1.27.0-dev-f12afb documentationãƒ«ãƒ¼ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸãƒªã‚¹ãƒŠãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_route_configs}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ãƒ«ãƒ¼ãƒˆå€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_route_configs}\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ãƒªã‚¹ãƒŠãƒ¼å€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸãƒ«ãƒ¼ãƒˆå€¤ã®åå‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‘ã‚¹ã‚„Hostãƒ˜ãƒƒãƒ€ãƒ¼ã«å¿œã˜ã¦ãƒ«ãƒ¼ãƒˆå€¤ã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãƒ«ãƒ¼ãƒˆå€¤ã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰configs:  - \"@type\": type.googleapis.com/envoy.admin.v3.RoutesConfigDump.DynamicRouteConfig    version_info: 2022-11-24T12:13:05Z/468    route_config:      \"@type\": type.googleapis.com/envoy.config.route.v3.RouteConfiguration      # ãƒ«ãƒ¼ãƒˆå€¤ã®åå‰      name: 50002      virtual_hosts:        - name: bar-service.bar-namespace.svc.cluster.local:50002          # ãƒ›ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°          domains:            - bar-service.bar-namespace.svc.cluster.local            - bar-service.bar-namespace.svc.cluster.local:50002            - bar-service            - bar-service:50002            - bar-service.bar-namespace.svc            - bar-service.bar-namespace.svc:50002            - bar-service.bar-namespace            - bar-service.bar-namespace:50002            - 172.16.0.2            - 172.16.0.2:50002          routes:            - match:                # ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°                prefix: /              route:                # æœ¬ãƒ«ãƒ¼ãƒˆã«ç´ã¥ãã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰                cluster: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local                timeout: 0s                retry_policy:                  retry_on: connect-failure,refused-stream,unavailable,cancelled,retriable-status-codes                  num_retries: 2                  retry_host_predicate:                    - name: envoy.retry_host_predicates.previous_hosts                  host_selection_retry_max_attempts: \"5\"                  retriable_status_codes:                    - 503                max_stream_duration:                  max_stream_duration: 0s                  grpc_timeout_header_max: 0s              decorator:                operation: bar-service.bar-namespace.svc.cluster.local:50002/*  ...  - '@type': type.googleapis.com/envoy.admin.v3.RoutesConfigDump.DynamicRouteConfig  ...â†ªï¸ï¼šAdministration interface â€” envoy 1.27.0-dev-f12afb documentationConfigDump (proto) â€” envoy 1.27.0-dev-f12afb documentationã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã¯ã€/config_dump?resource={dynamic_active_clusters}ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?resource={dynamic_active_clusters}\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆå€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®è¦ªåconfigs:  - \"@type\": type.googleapis.com/envoy.admin.v3.ClustersConfigDump.DynamicCluster    version_info: 2022-11-24T12:13:05Z/468    cluster:      \"@type\": type.googleapis.com/envoy.config.cluster.v3.Cluster      # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã®åå‰      name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local      type: EDS      eds_cluster_config:        eds_config:          ads: {}          initial_fetch_timeout: 0s          resource_api_version: V3        # æœ¬ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®è¦ªå        service_name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local  ...  - \"@type\": type.googleapis.com/envoy.admin.v3.ClustersConfigDump.DynamicCluster  ...â†ªï¸ï¼šAdministration interface â€” envoy 1.27.0-dev-f12afb documentationConfigDump (proto) â€” envoy 1.27.0-dev-f12afb documentationã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤â–¼ ç¢ºèªæ–¹æ³•istio-proxyã‚³ãƒ³ãƒ†ãƒŠãŒADS-APIã‹ã‚‰å–å¾—ã—ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã¯ã€/config_dump?include_edsã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚ã“ã“ã§ã¯ã€foo-podå†…ã§bar-podã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’ç¢ºèªã—ãŸã¨ä»®å®šã—ã¾ã™ã€‚$ kubectl exec \\    -it foo-pod \\    -n foo-namespace \\    -c istio-proxy \\    -- bash -c \"curl http://localhost:15000/config_dump?include_eds\" | yq -Pâ–¼ çµæœã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨YAMLã‚’å–å¾—ã§ãã€ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ã‚’å–å¾—ã—ãŸæ™‚ã«ç¢ºèªã§ããŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¦ªåbar-podã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ3å€‹ã‚ã‚‹ãŸã‚ã€3å€‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™configs:  dynamic_endpoint_configs:    - endpoint_config:        \"@type\": type.googleapis.com/envoy.config.endpoint.v3.ClusterLoadAssignment        # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¦ªå        cluster_name: outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local        endpoints:          - locality:              region: ap-northeast-1              zone: ap-northeast-1a            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.1                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1          - locality:              region: ap-northeast-1              zone: ap-northeast-1d            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.2                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1          - locality:              region: ap-northeast-1              zone: ap-northeast-1d            lb_endpoints:              - endpoint:                  address:                    socket_address:                      # å†—é•·åŒ–ã•ã‚ŒãŸbar-podã®IPã‚¢ãƒ‰ãƒ¬ã‚¹                      address: 11.0.0.3                      # bar-podå†…ã®ã‚³ãƒ³ãƒ†ãƒŠãŒå¾…ã¡å—ã‘ã¦ã„ã‚‹ãƒãƒ¼ãƒˆç•ªå·                      port_value: 80                  health_check_config: {}                health_status: HEALTHY                metadata:                  filter_metadata:                    istio:                      workload: bar                    envoy.transport_socket_match:                      tlsMode: istio                # ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ±ºã‚ã‚‹æ•°å€¤                load_balancing_weight: 1        policy:          overprovisioning_factor: 140    ...    - endpoint_config:    ...â†ªï¸å‚è€ƒï¼šAdministration interface â€” envoy 1.27.0-dev-f12afb documentationConfigDump (proto) â€” envoy 1.27.0-dev-f12afb documentationSupported load balancers â€” envoy 1.27.0-dev-f12afb documentationload_balancing_weightã‚­ãƒ¼å€¤ãŒç­‰ã—ã„å ´åˆã€Envoyã¯P2Cã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«åŸºã¥ã„ã¦ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ã¾ã™ğŸ‘Envoyã®å‡¦ç†ã®æµã‚Œã®ã¾ã¨ã‚ç¢ºèªã§ããŸå®›å…ˆæƒ…å ±ã‚’ã€Envoyã®å‡¦ç†ã®æµã‚Œã«å½“ã¦ã¯ã‚ã¦ã¿ã¾ã—ãŸã€‚ã€ï¼‘ã€‘é€ä¿¡å…ƒãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å®›å…ˆãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ (\u003cä»»æ„ã®IP\u003e/:50002) ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®istio-proxyã‚³ãƒ³ãƒ†ãƒŠã¯ã“ã‚Œã‚’å—ä¿¡ã—ã¾ã™ã€‚ã€ï¼’ã€‘Envoyã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®›å…ˆ (IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç•ªå·ã€ãƒ‘ã‚¹) ã‹ã‚‰Podã®ãƒªã‚¹ãƒŠãƒ¼å€¤ (0.0.0.0_50002) ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼“ã€‘Envoyã¯ã€ãƒªã‚¹ãƒŠãƒ¼ã«ç´ã¥ãPodã®ãƒ«ãƒ¼ãƒˆå€¤ (50002) ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼”ã€‘Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãPodã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å€¤ (outbound|50002|v1|bar-service.bar-namespace.svc.cluster.local) ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼•ã€‘Envoyã¯ã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«ç´ã¥ãPodã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ (11.0.0.X/:80) ã‚’é¸ã³ã¾ã™ã€‚ã€ï¼–ã€‘Envoyã¯ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå€¤ã®å®›å…ˆã«Podã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã®å†’é™ºã¯ä»¥ä¸Šã§ã™â›µ05. ãŠã‚ã‚Šã«Istioã®æ©Ÿèƒ½ã®ä¸€ã¤ã§ã‚ã‚‹ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼ã€ã®ä»•çµ„ã¿ã‚’ã€Envoyã‚’äº¤ãˆãªãŒã‚‰ã‚‚ã‚Šã‚‚ã‚Šå¸ƒæ•™ã—ã¾ã—ãŸã€‚æ„›ãŒæº¢ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚Istioã®æ©Ÿèƒ½ã‚’ä¸€ã¤ã¨ã£ã¦ã‚‚ã€è¤‡é›‘ãªä»•çµ„ã¿ã§å®Ÿç¾ã—ã¦ã„ã‚‹ã“ã¨ãŒãŠåˆ†ã‹ã‚Šã„ãŸã ã‘ãŸã‹ã¨æ€ã„ã¾ã™ (Istioã‚ã‚ŠãŒã¨ã†ğŸ™)è¬è¾3-shake SRE Tech Talk ã§ã®ç™ºè¡¨å‰å¾Œã«ã€ä»¥ä¸‹ã®æ–¹ã€…ã«ã€ç™ºè¡¨å†…å®¹ã«ã¤ã„ã¦åŠ©è¨€ã‚’ã„ãŸã ãã¾ã—ãŸã€‚@ido_kara_deru ã•ã‚“@yosshi_ ã•ã‚“@yteraoka ã•ã‚“(ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †)ã¾ãŸã€ä»Šå›ã® 3-shake Advent Calender 2022 ã¯ã€ä»¥ä¸‹ã®æ–¹ã€…ã«ä¼ç”»ã„ãŸã ãã¾ã—ãŸã€‚@jigyakkuma_ ã•ã‚“@nwiizo ã•ã‚“(ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †)çš†æ§˜ã«æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ğŸ™‡ğŸ»â€","link":"https://hiroki-hasegawa.hatenablog.jp/entry/2022/12/25/060000","isoDate":"2022-12-24T21:00:00.000Z","dateMiliSeconds":1671915600000,"authorName":"Hiroki Hasegawa","authorId":"hiroki-hasegawa"}]},"__N_SSG":true},"page":"/members/[id]","query":{"id":"hiroki-hasegawa"},"buildId":"tGx2r-mCxkIqn2yX3IufJ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>